<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>YT çºŒå‚³ä¸Šå‚³ Â· æ‰‹æ©Ÿç‰ˆç²¾ç°¡</title>
<style>
  :root { --fg:#111; --muted:#6b7280; --line:#e5e7eb; --pri:#2563eb; --ok:#065f46; --warn:#b45309; }
  html,body { margin:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial; color:var(--fg); background:#fff; }
  .wrap { max-width:680px; margin:0 auto; padding:14px 14px 90px; }
  h1 { font-size:18px; margin:4px 0 12px; }
  .cell { background:#fff; border:1px solid var(--line); border-radius:12px; padding:12px; margin-bottom:12px; }
  .row { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
  label { font-size:14px; color:#374151; }
  .muted { color:var(--muted); }
  .ok { color:var(--ok); }
  .warn { color:var(--warn); }
  input[type="text"], input[type="datetime-local"], textarea, select {
    width:100%; padding:12px; font-size:16px; border:1px solid var(--line); border-radius:10px; background:#fff;
  }
  textarea { resize:vertical; min-height:96px; }
  input[type="file"] { width:100%; font-size:16px; }
  .btn { width:100%; padding:14px 16px; font-size:16px; border-radius:12px; border:1px solid var(--line); background:#fff; }
  .btn.primary { background:var(--pri); color:#fff; border-color:var(--pri); }
  .btn:disabled { opacity:.6; }
  .btn.ghost { background:#fff; color:#111; }
  .kv { display:grid; grid-template-columns:96px 1fr; gap:6px 10px; font-size:14px; }
  .kv div.key { color:var(--muted); }
  .pill { font-size:12px; border:1px solid var(--line); border-radius:999px; padding:4px 8px; color:#374151; }
  .prog { width:100%; height:10px; background:#eee; border-radius:999px; overflow:hidden; }
  .bar { height:100%; width:0%; background:#2563eb; transition:width .2s; }
  .sticky { position:fixed; left:0; right:0; bottom:0; background:#fff; border-top:1px solid var(--line); padding:10px 14px; }
  .two { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
  .actions { display:flex; gap:10px; }
  .right { margin-left:auto; }
</style>
<script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
<div class="wrap">
  <h1>ğŸ“¤ ä¸Šå‚³ YouTubeï¼ˆçºŒå‚³ï¼‰ï¼‹ å›å¯« Sheet</h1>

  <!-- ç™»å…¥ -->
  <div class="cell">
    <div class="row">
      <button id="btnAuth" class="btn">Google ç™»å…¥ / å–å¾—æˆæ¬Š</button>
      <span class="pill">Scopesï¼šyoutube.upload, youtube</span>
    </div>
    <div id="channelInfo" class="muted" style="margin-top:6px;">å°šæœªæˆæ¬Š</div>
  </div>

  <!-- é¸å½±ç‰‡ -->
  <div class="cell">
    <div class="row">
      <input id="file" type="file" accept="video/*" required />
    </div>
    <div id="resumeHint" class="muted" style="margin-top:6px; display:none;"></div>
    <div id="parseBox" class="muted" style="margin-top:8px;">å°šæœªè§£æ</div>
  </div>

  <!-- ä¸»è¦æ¬„ä½ + AI -->
  <div class="cell">
    <div class="row">
      <input id="title" type="text" placeholder="ç‰‡åï¼ˆé è¨­å–æª”åï¼‰" required />
      <button id="btnAI" class="btn ghost" style="width:auto; padding:10px 12px;">âœ¨ AI ç”Ÿæˆ</button>
    </div>
    <div class="row" style="margin-top:8px;">
      <select id="privacy" required>
        <option value="unlisted">ä¸å…¬é–‹</option>
        <option value="public">å…¬é–‹</option>
        <option value="private">ç§äºº</option>
      </select>
    </div>
    <div class="row" style="margin-top:8px;">
      <textarea id="desc" placeholder="æè¿°" required></textarea>
    </div>
  </div>

  <!-- æ‹æ”æ™‚é–“ / åº§æ¨™ / è‡ªè¨‚åˆ†é¡ -->
  <div class="cell">
    <div class="row two">
      <div>
        <label>æ‹æ”æ™‚é–“</label>
        <input id="takenTime" type="datetime-local" required />
      </div>
      <div>
        <label>æ—…éŠåˆ†é¡</label>
        <select id="category" required>
          <option value=""></option>
          <optgroup label="æ—…éŠä¸»é¡Œ">
            <option>åŸå¸‚æ¼«éŠ</option><option>æ–‡åŒ–æ­·å²</option><option>è‡ªç„¶é¢¨å…‰</option>
            <option>ç¾é£Ÿæ¢ç´¢</option><option>äº¤é€šç´€éŒ„</option><option>ä½å®¿é«”é©—</option>
          </optgroup>
          <optgroup label="æ´»å‹•å‹æ…‹">
            <option>å†’éšªæŒ‘æˆ°</option><option>ä¼‘é–’æ”¾é¬†</option><option>æ´»å‹•å¯«ç…§</option>
          </optgroup>
        </select>
      </div>
    </div>
    <div class="row two" style="margin-top:8px;">
      <div>
        <label>ç·¯åº¦</label>
        <input id="lat" type="text" placeholder="25.033964" inputmode="decimal" required />
      </div>
      <div>
        <label>ç¶“åº¦</label>
        <input id="lng" type="text" placeholder="121.564468" inputmode="decimal" required />
      </div>
    </div>
    <div class="actions" style="margin-top:8px;">
      <button id="btnGeo" class="btn">ç”¨ç›®å‰ä½ç½®</button>
      <label class="right row" style="gap:6px;">
        <input id="writeSheet" type="checkbox" checked />
        <span class="muted">ä¸Šå‚³å®Œæˆå¯«å…¥ Sheet</span>
      </label>
    </div>
    <div id="geoInfo" class="muted" style="margin-top:6px;"></div>
  </div>

  <!-- é€²åº¦ -->
  <div class="cell">
    <div id="status" class="muted">å¾…å‘½</div>
    <div class="prog" style="margin-top:8px;"><div id="bar" class="bar"></div></div>
    <div id="progressText" class="muted" style="margin-top:6px;"></div>
    <div id="result" style="margin-top:8px;"></div>
  </div>
</div>

<!-- å›ºå®šä¸‹æ–¹ä¸»å‹•ä½œ -->
<div class="sticky">
  <button id="btnUpload" class="btn primary">ğŸš€ é–‹å§‹ä¸Šå‚³ï¼ˆæ”¯æ´çºŒå‚³ï¼‰</button>
</div>

<script>
/** å¿…å¡«ï¼šä½ çš„ Google OAuth Client ID èˆ‡ GAS Web App URL */
const CLIENT_ID = '783633103016-3e7u1n8vpt9essjnct4dirije16u8b23.apps.googleusercontent.com';
const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyp8aXKyRbIAexuZ2c81bYivXGr9gujK91n741f-_zOMpnPeNhsT_1CHlXbPg0U8fFZ/exec';

/** çºŒå‚³è¨­å®š */
const CHUNK_SIZE = 8 * 1024 * 1024; // 8MBï¼ˆ256KB å€æ•¸ï¼‰
const RESUME_PREFIX = 'ytResumable:';

let tokenClient, accessToken = null;
let parsedMeta = { creation: null, location: null };
let currentChannel = null;

const scopes = 'https://www.googleapis.com/auth/youtube.upload https://www.googleapis.com/auth/youtube';

const el = id => document.getElementById(id);
const chInfo=el('channelInfo'), parseBox=el('parseBox'), geoInfo=el('geoInfo'), result=el('result');
const btnAuth=el('btnAuth'), btnGeo=el('btnGeo'), btnUpload=el('btnUpload'), btnAI=el('btnAI');
const fileInput=el('file'), titleEl=el('title'), descEl=el('desc'), catEl=el('category'), privacyEl=el('privacy');
const takenEl=el('takenTime'), latEl=el('lat'), lngEl=el('lng'), writeSheetEl=el('writeSheet');
const bar=el('bar'), statusEl=el('status'), progressText=el('progressText'), resumeHint=el('resumeHint');
// ç‰‡é•·ï¼ˆç§’ï¼‰
let durationSec = null;

function formatDuration(sec){
  if (!Number.isFinite(sec)) return '';
  sec = Math.max(0, Math.round(sec));
  const h = Math.floor(sec/3600);
  const m = Math.floor((sec%3600)/60);
  const s = sec%60;
  return h ? `${h}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`
           : `${m}:${String(s).padStart(2,'0')}`;
}

window.onload = () => {
  const saved = localStorage.getItem('ytAccessToken');
  if (saved) {
    accessToken = saved;
    fetchChannel(); // ç›´æ¥æ‹¿èˆŠçš„ token è©¦
  } else {
  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: CLIENT_ID, scope: scopes,
    callback: (resp) => {
      if (resp.error) { alert('æˆæ¬Šå¤±æ•—ï¼š' + resp.error); return; }
      accessToken = resp.access_token; 
      localStorage.setItem('ytAccessToken', accessToken); // å­˜èµ·ä¾†
      fetchChannel();
    }}}
  });
  btnAuth.addEventListener('click', () => tokenClient.requestAccessToken());
  fileInput.addEventListener('change', onChooseFile);
  btnGeo.addEventListener('click', getGeolocation);
  btnUpload.addEventListener('click', startUpload);
  btnAI.addEventListener('click', aiGenerate); // â˜… ç¶å®š AI ç”Ÿæˆ
};

/** é¡¯ç¤ºç›®å‰é »é“ */
async function fetchChannel(){
  try{
    const res = await fetch('https://www.googleapis.com/youtube/v3/channels?part=snippet&mine=true', {
      headers: { Authorization: 'Bearer ' + accessToken }
    });
    const data = await res.json();
    if (data?.items?.length){
      const ch = data.items[0];
      currentChannel = { id: ch.id, title: ch.snippet.title };
      chInfo.innerHTML = `å·²æˆæ¬Šï¼š<b>${escapeHtml(ch.snippet.title)}</b>`;
    } else chInfo.textContent = 'æ‰¾ä¸åˆ°æˆæ¬Šé »é“ï¼Œè«‹ç¢ºèªé¸å°å“ç‰Œé »é“';
  }catch(e){ chInfo.textContent = 'æŸ¥è©¢é »é“å¤±æ•—ï¼š' + e; }
}

/** é¸æª” â†’ è§£æä¸­ç¹¼è³‡æ–™ï¼ˆæ‹æ”æ™‚é–“/åº§æ¨™ï¼‰â†’ è‡ªå‹•å¡«å…¥ */
async function onChooseFile(){
  resetProgressUI(); result.innerHTML = ''; parseBox.textContent = 'è§£æä¸­â€¦';
  const f = fileInput.files?.[0]; if (!f){ parseBox.textContent = 'å°šæœªè§£æ'; return; }
  if (!titleEl.value) titleEl.value = (f.name || '').replace(/\.[^.]+$/, '');

  // â˜… è®€å–ç‰‡é•·
  durationSec = await getVideoDurationFromFile(f); // å–å¾—ç§’æ•¸ï¼ˆnumberï¼‰
  const meta = await extractVideoMeta(f);
  parsedMeta = meta;
  applyParsedToFields(meta);

  let html = `<div class="ok">âœ… è§£æå®Œæˆ</div>
              <div class="kv" style="margin-top:6px;">
                <div class="key">æª”å</div><div class="val">${escapeHtml(f.name)}ï¼ˆ${Math.round(f.size/1024/1024)} MBï¼‰</div>
                <div class="key">æ‹æ”æ™‚é–“</div><div class="val">${meta.creation?escapeHtml(meta.creation):'<span class="warn">æœªå–å¾—</span>'}</div>
                <div class="key">åº§æ¨™</div><div class="val">${
                  meta.location ? `${meta.location.lat.toFixed(6)}, ${meta.location.lng.toFixed(6)}` : '<span class="warn">æœªå–å¾—</span>'
                }</div>
                <div class="key">ç‰‡é•·</div><div class="val">${durationSec!=null ? formatDuration(durationSec) : 'â€”'}</div>
              </div>`;
  parseBox.innerHTML = html;

  const info = getResume(getFileId(f));
  if (info?.uploadUrl){ resumeHint.style.display=''; resumeHint.textContent='åµæ¸¬åˆ°æœªå®Œæˆä¸Šå‚³ï¼Œå°‡è‡ªå‹•çºŒå‚³'; }
  else { resumeHint.style.display='none'; resumeHint.textContent=''; }
}

/** å°‡è§£æçµæœå¸¶å…¥æ¬„ä½ï¼ˆåƒ…åœ¨ä½ æœªæ‰‹å¡«æ™‚ï¼‰ */
function applyParsedToFields(meta){
  if (meta.creation && !takenEl.value){
    const d = new Date(meta.creation); if (!isNaN(d)) takenEl.value = toLocalDatetimeInputValue(d);
  }
  if (meta.location){
    if (!latEl.value) latEl.value = String(meta.location.lat);
    if (!lngEl.value) lngEl.value = String(meta.location.lng);
  }
}
async function getVideoDurationFromFile(file){
  return new Promise((resolve) => {
    try{
      const url = URL.createObjectURL(file);
      const v = document.createElement('video');
      v.preload = 'metadata';
      v.onloadedmetadata = () => {
        const d = Number.isFinite(v.duration) ? v.duration : null;
        URL.revokeObjectURL(url);
        resolve(d != null ? Math.round(d) : null);
      };
      v.onerror = () => { URL.revokeObjectURL(url); resolve(null); };
      v.src = url;
    }catch(_){ resolve(null); }
  });
}  

/** ç›®å‰ä½ç½®å¡«å…¥ */
function getGeolocation(){
  if (!navigator.geolocation) return alert('æ­¤ç€è¦½å™¨ä¸æ”¯æ´å®šä½');
  navigator.geolocation.getCurrentPosition(
    pos => {
      const { latitude, longitude } = pos.coords;
      latEl.value = latitude.toFixed(6);
      lngEl.value = longitude.toFixed(6);
      geoInfo.textContent = `å·²å¡«å…¥ç›®å‰ä½ç½®ï¼š${latEl.value}, ${lngEl.value}`;
    },
    err => alert('å®šä½å¤±æ•—ï¼š' + err.message),
    { enableHighAccuracy:true, timeout:15000 }
  );
}

/** â˜… AI ç”Ÿæˆæ¨™é¡Œ/æè¿°ï¼ˆæ“·å–å½±æ ¼â†’ä¸Ÿ GAS: action=aiVideodescï¼‰ */
async function aiGenerate(){
  const f = fileInput.files?.[0];
  if (!f) return alert('è«‹å…ˆé¸æ“‡å½±ç‰‡');
  try{
    disableAI(true);
    setStatus('AI åˆ†æå½±æ ¼ä¸­â€¦');
    const frames = await captureFramesFromVideoFile(f, [0.05, 0.55, 0.95], 384);

    setStatus('AI ç”¢ç”Ÿå»ºè­°ä¸­â€¦');
    const hint = {
      taken_time: getTakenISO() || '',
      lat: parseFloat(latEl.value), lng: parseFloat(lngEl.value),
      category_fixed: 'Travel & Events'
    };
    const r = await fetch(GAS_WEB_APP_URL + '?action=aiVideodesc', {
      method:'POST',
      headers:{ 'Content-Type':'text/plain;charset=utf-8' }, // é¿å…é æª¢
      body: JSON.stringify({ images: frames, hint })
    });
    const j = await r.json();

    if (!j.ok) throw new Error(j.error || 'AI ç”Ÿæˆå¤±æ•—');

    if (j.title) titleEl.value = j.title;   // ä¸ç®¡åŸæœ¬æ˜¯å¦æœ‰å­—ï¼Œéƒ½æ”¹
    const tagsLine = (j.tags && j.tags.length) ? j.tags.map(t=>`#${String(t).replace(/\s+/g,'')}`).join(' ') : '';
    if (j.desc) {
      descEl.value = j.desc + (tagsLine ? `\n\n${tagsLine}` : '');
    } else if (tagsLine) {
      descEl.value = (descEl.value ? descEl.value + '\n\n' : '') + tagsLine;
    }
    const suggestedCat = pickCustomCategoryFromAI({ title: j.title, desc: j.desc, tags: j.tags });
     if (suggestedCat && !catEl.value) {
       catEl.value = suggestedCat;
    }
    setStatus('AI å»ºè­°å·²å¥—ç”¨ âœ…');
  }catch(e){
    alert('AI ç”Ÿæˆå¤±æ•—ï¼š' + e.message);
    setStatus('AI å¤±æ•—');
  }finally{
    disableAI(false);
  }
}
function disableAI(dis){ btnAI.disabled = !!dis; }

/** ä¸Šå‚³æµç¨‹ï¼ˆå«çºŒå‚³èˆ‡æ’­æ”¾æ¸…å–®ï¼‰ */
async function startUpload(){
  const f = fileInput.files?.[0];
  if (!f) return alert('è«‹å…ˆé¸æ“‡å½±ç‰‡');
  if (!accessToken) return alert('è«‹å…ˆç™»å…¥');

  disableUI(true); resetProgressUI(); setStatus('æº–å‚™ä¸Šå‚³â€¦');

  try{
    const fileId = getFileId(f);
    let { uploadUrl } = getOrCreateResume(fileId);
    if (!uploadUrl){
      const initBody = buildInitBody(f);
      uploadUrl = await startResumableSession(initBody, f);
      saveResume(fileId, uploadUrl);
    }
    let offset = await queryUploadOffset(uploadUrl, f.size);

    const videoId = await uploadInChunks(uploadUrl, f, offset, (sent, total) => {
      const pct = Math.floor(sent / total * 100);
      setProgress(pct);
      progressText.textContent = `${formatBytes(sent)} / ${formatBytes(total)}ï¼ˆ${pct}%ï¼‰`;
      setStatus('ä¸Šå‚³ä¸­â€¦');
    });
    if (!videoId) throw new Error('æœªå–å¾— videoId');

    const PLAYLIST_TITLE = "å³æ™‚æ—…è¡Œåˆ†äº«";
    const playlistId = await ensurePlaylist(PLAYLIST_TITLE);
    await addVideoToPlaylist(videoId, playlistId);

    setStatus('å›å¯« Google Sheetâ€¦'); setProgress(98);

    const takenISO = getTakenISO();
    const hasLoc = hasLocation();
    const lat = parseFloat(latEl.value), lng = parseFloat(lngEl.value);
    const now = new Date();
    const uploadLocal = toLocalDatetimeInputValue(now);

    if (writeSheetEl.checked){
      await writeToGAS({
        upload_time: uploadLocal,
        taken_time: takenEl.value || '',
        title: titleEl.value?.trim() || f.name,
        desc:  descEl.value || '',
        lat: hasLoc ? lat : '',
        lng: hasLoc ? lng : '',
        category: catEl.value || '',
        video_id: videoId,
        status: privacyEl.value,
        duration_sec: Number.isFinite(durationSec) ? durationSec : ''
      });
    }

    setProgress(100);
    result.innerHTML = `<div class="ok">âœ… å®Œæˆï¼š<a target="_blank" href="https://youtu.be/${videoId}">https://youtu.be/${videoId}</a></div>`;
    setStatus('å®Œæˆ');

    clearResume(fileId); resetForm();
  }catch(e){
    setStatus('ä¸Šå‚³ä¸­æ–·æˆ–å¤±æ•—ï¼ˆå¯ç¨å¾ŒçºŒå‚³ï¼‰');
    result.innerHTML = `<div class="warn">âŒ ç™¼ç”ŸéŒ¯èª¤ï¼š${escapeHtml(String(e))}</div>`;
  }finally{
    disableUI(false);
  }
}

/** åˆå§‹åŒ– bodyï¼ˆå¸¶ recordingDetailsï¼›åˆ†é¡å›ºå®š 19ï¼‰ */
function buildInitBody(file){
  const title = titleEl.value?.trim() || file.name;
  const desc  = descEl.value || '';
  const privacy = privacyEl.value || 'unlisted';
  const meta = { snippet:{ title, description: desc, categoryId:'19' }, status:{ privacyStatus: privacy } };
  const takenISO = getTakenISO(); const hasLoc = hasLocation();
  if (takenISO || hasLoc){
    meta.recordingDetails = {};
    if (takenISO) meta.recordingDetails.recordingDate = takenISO;
    if (hasLoc) meta.recordingDetails.location = { latitude: parseFloat(latEl.value), longitude: parseFloat(lngEl.value), altitude: 0 };
  }
  return meta;
}

/** æ‹æ”æ™‚é–“ ISO */
function getTakenISO(){
  if (takenEl.value){ const d = new Date(takenEl.value); if (!isNaN(d)) return d.toISOString(); }
  else if (parsedMeta.creation) return parsedMeta.creation;
  return '';
}
function hasLocation(){ const lat = parseFloat(latEl.value), lng = parseFloat(lngEl.value); return !isNaN(lat) && !isNaN(lng); }

/** Resumable API */
async function startResumableSession(initBody, file){
  const initRes = await fetch('https://www.googleapis.com/upload/youtube/v3/videos?uploadType=resumable&part=snippet,status,recordingDetails', {
    method:'POST',
    headers:{
      Authorization: 'Bearer '+accessToken,
      'Content-Type': 'application/json; charset=UTF-8',
      'X-Upload-Content-Length': file.size,
      'X-Upload-Content-Type': file.type || 'video/*'
    },
    body: JSON.stringify(initBody)
  });
  if (!initRes.ok){ const t = await initRes.text(); throw new Error('åˆå§‹åŒ–å¤±æ•—ï¼š'+t); }
  const uploadUrl = initRes.headers.get('Location');
  if (!uploadUrl) throw new Error('æœªå–å¾—çºŒå‚³ URL');
  return uploadUrl;
}
async function queryUploadOffset(uploadUrl, totalSize){
  const res = await fetch(uploadUrl, { method: 'PUT', headers: { 'Content-Range': 'bytes */' + totalSize, 'Content-Length': '0' } });
  if (res.status === 308){
    const range = res.headers.get('Range'); if (range){ const m = range.match(/bytes=(\d+)-(\d+)/); if (m) return parseInt(m[2], 10) + 1; }
    return 0;
  }
  if (res.ok) return totalSize; return 0;
}
async function uploadInChunks(uploadUrl, file, startOffset, onProgress){
  let offset = startOffset || 0; const total = file.size;
  while (offset < total){
    const end = Math.min(offset + CHUNK_SIZE, total) - 1;
    const chunk = file.slice(offset, end + 1);
    const res = await fetch(uploadUrl, {
      method:'PUT',
      headers:{ 'Content-Type': file.type || 'application/octet-stream', 'Content-Length': String(end - offset + 1), 'Content-Range': `bytes ${offset}-${end}/${total}` },
      body: chunk
    });
    if (res.status === 308){
      const range = res.headers.get('Range'); offset = range ? (parseInt(range.match(/bytes=(\d+)-(\d+)/)[2],10)+1) : (end+1);
      onProgress && onProgress(offset, total); continue;
    }
    const txt = await res.text();
    if (res.ok){ const json = safeJson(txt); return json?.id || null; }
    throw new Error(`ä¸Šå‚³å¤±æ•—ï¼ˆHTTP ${res.status}ï¼‰ï¼š${txt.slice(0,300)}`);
  }
  return null;
}

/** å–å¾—æ¸…å–®IDï¼›è‹¥ä¸å­˜åœ¨å°±å»ºç«‹ä¸€å€‹ä¸¦å›å‚³ ID */
async function ensurePlaylist(title){
  let pageToken = "", found = null;
  do {
    const url = new URL("https://www.googleapis.com/youtube/v3/playlists");
    url.searchParams.set("part", "snippet");
    url.searchParams.set("mine", "true");
    url.searchParams.set("maxResults", "50");
    if (pageToken) url.searchParams.set("pageToken", pageToken);

    const res = await fetch(url, { headers:{ Authorization: "Bearer " + accessToken } });
    const data = await res.json();
    if (data?.items?.length){
      found = data.items.find(pl => (pl.snippet?.title || "") === title);
      if (found) return found.id;
    }
    pageToken = data.nextPageToken || "";
  } while (pageToken);

  const createRes = await fetch("https://www.googleapis.com/youtube/v3/playlists?part=snippet,status", {
    method: "POST",
    headers: { Authorization: "Bearer " + accessToken, "Content-Type":"application/json" },
    body: JSON.stringify({
      snippet: { title, description: "å³æ™‚æ—…è¡Œçš„ä¸Šå‚³è‡ªå‹•å½™æ•´" },
      status: { privacyStatus: "unlisted" }
    })
  });
  if (!createRes.ok) throw new Error("å»ºç«‹æ’­æ”¾æ¸…å–®å¤±æ•—ï¼š" + (await createRes.text()).slice(0,300));
  const created = await createRes.json();
  return created.id;
}

/** æŠŠå½±ç‰‡åŠ å…¥æŒ‡å®šæ¸…å–® */
async function addVideoToPlaylist(videoId, playlistId){
  const res = await fetch("https://www.googleapis.com/youtube/v3/playlistItems?part=snippet", {
    method: "POST",
    headers: { Authorization: "Bearer " + accessToken, "Content-Type":"application/json" },
    body: JSON.stringify({ snippet: { playlistId, resourceId: { kind: "youtube#video", videoId } } })
  });
  if (!res.ok) throw new Error("åŠ å…¥æ’­æ”¾æ¸…å–®å¤±æ•—ï¼š" + (await res.text()).slice(0,300));
}  

/** å¯«å› GASï¼ˆtext/plain é¿å…é æª¢ï¼‰ */
async function writeToGAS(payload){
  const r = await fetch(GAS_WEB_APP_URL, { method:'POST', headers:{ 'Content-Type':'text/plain;charset=utf-8' }, body: JSON.stringify(payload) });
  const text = await r.text(); let j; try{ j = JSON.parse(text); }catch{ throw new Error('GAS å›å‚³ä¸æ˜¯ JSONï¼š\n' + text.slice(0,500)); }
  if (!r.ok || !j.ok) throw new Error(j.error || `HTTP ${r.status}`); return j;
}

/** â€”â€” çºŒå‚³è³‡è¨Šï¼ˆè‡ªå‹•è™•ç†ï¼‰ â€”â€” */
function getFileId(file){ return `${file.name}_${file.size}_${file.lastModified}`; }
function getResumeKey(fileId){ return RESUME_PREFIX + fileId; }
function getResume(fileId){ try { return JSON.parse(localStorage.getItem(getResumeKey(fileId)) || 'null') || null; } catch { return null; } }
function saveResume(fileId, uploadUrl){ localStorage.setItem(getResumeKey(fileId), JSON.stringify({ uploadUrl, updated: Date.now() })); }
function clearResume(fileId){ localStorage.removeItem(getResumeKey(fileId)); }
function getOrCreateResume(fileId){ return getResume(fileId) || { uploadUrl: null }; }

/** â€”â€” UI helpers â€”â€” */
function setStatus(msg){ statusEl.textContent = msg; }
function setProgress(p){ bar.style.width = Math.max(0, Math.min(100, p)) + '%'; }
function resetProgressUI(){ setProgress(0); progressText.textContent = ''; setStatus('å¾…å‘½'); }
function disableUI(dis){
  [btnAuth, fileInput, btnGeo, btnUpload, btnAI, titleEl, descEl, catEl, privacyEl, takenEl, latEl, lngEl, writeSheetEl]
    .forEach(elm => elm.disabled = !!dis);
}
function resetForm(){
  fileInput.value = ''; titleEl.value = ''; descEl.value = ''; catEl.value = '';
  privacyEl.value = 'unlisted'; takenEl.value = ''; latEl.value = ''; lngEl.value = '';
  writeSheetEl.checked = true; parsedMeta = { creation:null, location:null };
  parseBox.textContent = 'å°šæœªè§£æ'; resumeHint.style.display = 'none'; result.innerHTML = ''; resetProgressUI();
}
function toLocalDatetimeInputValue(d){ const pad=n=>String(n).padStart(2,'0'); const y=d.getFullYear(), m=pad(d.getMonth()+1), da=pad(d.getDate()), h=pad(d.getHours()), mi=pad(d.getMinutes()); return `${y}-${m}-${da}T${h}:${mi}`; }
function safeJson(t){ try{ return JSON.parse(t);}catch{ return {}; } }
function escapeHtml(s){ return String(s ?? '').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function formatBytes(b){ if (b < 1024) return `${b} B`; const u=['KB','MB','GB','TB']; let i=-1; do{ b/=1024; i++; }while(b>=1024 && i<u.length-1); return `${b.toFixed(1)} ${u[i]}`; }

/** â€”â€” å½±ç‰‡ä¸­ç¹¼è³‡æ–™è§£æ â€”â€” */
async function extractVideoMeta(file){
  const headSize = Math.min(file.size, 8*1024*1024);
  const headBuf  = await file.slice(0, headSize).arrayBuffer();
  let text = safeDecode(headBuf);
  let loc = findISO6709(text), cdate = findCreationDate(text);
  if ((!loc || !cdate) && headSize < file.size){
    const fullBuf = await file.arrayBuffer();
    text = safeDecode(fullBuf);
    if (!loc)   loc   = findISO6709(text);
    if (!cdate) cdate = findCreationDate(text);
  }
  if (!loc)   loc   = findAfterKey(text, 'com.apple.quicktime.location.ISO6709');
  if (!cdate) cdate = findAfterKey(text, 'com.apple.quicktime.creationdate') || findAfterKey(text, 'Â©day');
  return { creation: normalizeDateTime(cdate) || null, location: loc ? iso6709ToLatLng(loc) : null };
}
function findISO6709(s){ const re=/[+-]\d{1,2}\.\d{3,}[+-]\d{1,3}\.\d{3,}(?:[+-]\d{1,3}\.\d+)?\/?/; const m=s.match(re); return m?m[0]:null; }
function findAfterKey(s,key){ const i=s.indexOf(key); if(i===-1) return null; const t=s.slice(i+key.length,i+key.length+200);
  const tm=t.match(/\d{4}-\d{2}-\d{2}[ T]\d{2}:\d{2}:\d{2}(?:\.\d+)?Z?/); if(tm) return tm[0];
  const lm=t.match(/[+-]\d{1,2}\.\d{3,}[+-]\d{1,3}\.\d{3,}(?:[+-]\d{1,3}\.\d+)?\/?/); if(lm) return lm[0];
  const pr=t.match(/[\x20-\x7E]{6,}/); return pr?pr[0].trim():null; }
function findCreationDate(s){ let m=s.match(/\d{4}-\d{2}-\d{2}[ T]\d{2}:\d{2}:\d{2}(?:\.\d+)?Z?/); if(m) return m[0]; m=s.match(/\d{4}:\d{2}:\d{2}\s\d{2}:\d{2}:\d{2}/); return m?m[0]:null; }
function iso6709ToLatLng(str){ const re=/^([+-]\d{1,2}\.\d+)([+-]\d{1,3}\.\d+)([+-]\d{1,3}\.\d+)?\/?$/; const m=str.match(re); if(!m) return null;
  return {lat:parseFloat(m[1]), lng:parseFloat(m[2]), alt:m[3]?parseFloat(m[3]):null}; }
function normalizeDateTime(s){ if(!s) return null;
  if(/^\d{4}-\d{2}-\d{2}[ T]\d{2}:\d{2}:\d{2}/.test(s)){ const t=s.replace(' ','T'); try{ return new Date(t).toISOString(); }catch{} }
  if(/^\d{4}:\d{2}:\d{2}\s\d{2}:\d{2}:\d{2}$/.test(s)){ const t=s.replace(/^(\d{4}):(\d{2}):(\d{2})\s/,'$1-$2-$3T')+'Z'; try{ return new Date(t).toISOString(); }catch{} }
  return s;
}
function safeDecode(buf){
  try{ return new TextDecoder('utf-8',{fatal:false}).decode(buf);}
  catch{
    let s=''; const c=1<<20;
    for(let i=0;i<buf.byteLength;i+=c){
      const view=new DataView(buf,i,Math.min(c,buf.byteLength-i));
      const arr=new Uint8Array(view.buffer,view.byteOffset,view.byteLength);
      s+=new TextDecoder('utf-8',{fatal:false}).decode(arr);
    }
    return s;
  }
}

/** â€”â€” å½±æ ¼æ“·å–ï¼šAI ä½¿ç”¨ â€”â€” */
async function captureFramesFromVideoFile(file, points=[0.1,0.6,0.95], w=384){
  const url = URL.createObjectURL(file);
  const v = document.createElement('video');
  v.src = url; v.muted = true; v.playsInline = true;
  await new Promise(r => v.onloadedmetadata = r);

  const h = Math.round((v.videoHeight / v.videoWidth) * w);
  const canvas = document.createElement('canvas'); canvas.width = w; canvas.height = h;
  const ctx = canvas.getContext('2d');

  const frames = [];
  for (const p of points){
    await new Promise(res => { const h=()=>{v.removeEventListener('seeked',h);res();}; v.addEventListener('seeked',h); v.currentTime = Math.min(Math.max((v.duration||0)*p,0), v.duration||0); });
    ctx.drawImage(v, 0, 0, w, h);
    const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
    frames.push({ mimeType:'image/jpeg', data: dataUrl.split(',')[1] });
  }
  URL.revokeObjectURL(url);
  return frames;
}

// ä¾ AI æ–‡å­—è‡ªå‹•åˆ¤æ–·è‡ªè¨‚æ—…éŠåˆ†é¡ï¼ˆåƒ…é¸ä½ ä¸‹æ‹‰è£¡çš„é¸é …ï¼‰
function pickCustomCategoryFromAI({ title = '', desc = '', tags = [] }) {
  const text = [title, desc, ...(tags || [])].join(' ').toLowerCase();

  // ä½ çš„ä¸‹æ‹‰é¸é …ï¼ˆå¿…é ˆèˆ‡ <select id="category"> çš„æ–‡å­—å®Œå…¨ä¸€è‡´ï¼‰
  const categories = [
    'åŸå¸‚æ¼«éŠ','æ–‡åŒ–æ­·å²','è‡ªç„¶é¢¨å…‰','ç¾é£Ÿæ¢ç´¢','äº¤é€šç´€éŒ„','ä½å®¿é«”é©—',
    'å†’éšªæŒ‘æˆ°','ä¼‘é–’æ”¾é¬†','æ´»å‹•å¯«ç…§'
  ];

  // é—œéµå­—å­—å…¸ï¼ˆå¯ä¾éœ€è¦è‡ªè¡Œè£œå¼·ï¼‰
  const dict = {
    'åŸå¸‚æ¼«éŠ': ['åŸå¸‚','è¡—é ­','è€è¡—','å¸‚å€','downtown','city walk','urban'],
    'æ–‡åŒ–æ­·å²': ['åšç‰©é¤¨','å¤è¹Ÿ','ç¥å»Ÿ','éºå€','æ­·å²','æ–‡åŒ–','heritage','museum','temple'],
    'è‡ªç„¶é¢¨å…‰': ['å±±','æµ·','æ¹–','ç€‘å¸ƒ','æ­¥é“','åœ‹å®¶å…¬åœ’','æ²™æ¼ ','æ—¥å‡º','å¤•é™½','è‡ªç„¶','trail','hike','waterfall','national park'],
    'ç¾é£Ÿæ¢ç´¢': ['ç¾é£Ÿ','å°åƒ','é¤å»³','å’–å•¡','å¸‚å ´','å¤œå¸‚','æ–™ç†','åƒ','tasty','food','street food','cafe'],
    'äº¤é€šç´€éŒ„': ['ç«è»Š','åœ°éµ','é«˜éµ','é›»è»Š','å…¬è»Š','é£›æ©Ÿ','èˆªç­','æ©Ÿå ´','æ·é‹','æ¸¡è¼ª','tram','train','metro','bus','flight','airport','ferry','drive','road trip'],
    'ä½å®¿é«”é©—': ['é£¯åº—','æ—…é¤¨','é’æ—…','æ°‘å®¿','éœ²ç‡Ÿè»Š','check-in','check in','æˆ¿å‹','ä½å®¿','hotel','hostel','camp'],
    'å†’éšªæŒ‘æˆ°': ['æ”€å²©','æ½›æ°´','è¡æµª','è·³å‚˜','æ»‘é›ª','å¥è¡ŒæŒ‘æˆ°','è¶Šé‡','æ¥µé™','å†’éšª','surf','dive','ski','climb','paragliding','challenge'],
    'ä¼‘é–’æ”¾é¬†': ['æº«æ³‰','æµ·ç˜','åº¦å‡','æ”¾ç©º','å’–å•¡å»³','spa','relax','resort','chill','beach'],
    'æ´»å‹•å¯«ç…§': ['ç¯€æ…¶','ç…™ç«','éŠè¡Œ','æ¼”å”±æœƒ','æ…¶å…¸','ç¥­å…¸','å©šç¦®','æ´»å‹•','è¡—é ­è—äºº','è¡¨æ¼”','festival','parade','concert','event']
  };

  // è¨ˆåˆ†
  let best = { cat: null, score: 0 };
  for (const cat of Object.keys(dict)) {
    let s = 0;
    for (const kw of dict[cat]) {
      // ç°¡å–®åŠ æ¬Šï¼šå®Œæ•´è© +2ï¼Œç‰‡æ®µ +1
      if (text.includes(kw.toLowerCase())) s += (kw.split(' ').length > 1 ? 2 : 1);
    }
    // æ¨™ç±¤ä¸­å®Œå…¨å‘½ä¸­çš„å†åŠ åˆ†
    for (const t of (tags || [])) {
      const tt = String(t).toLowerCase();
      if (dict[cat].some(kw => tt === kw.toLowerCase())) s += 2;
    }
    if (s > best.score) best = { cat, score: s };
  }

  // ä¿¡å¿ƒé–€æª»ï¼ˆé¿å…äº‚é…ï¼‰ï¼š>=2 åˆ†æ‰æ¡ç”¨
  if (best.score >= 2) return best.cat;
  return '';
}
  
</script>
</body>
</html>
