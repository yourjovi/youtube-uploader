<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>YT 續傳上傳＋寫回 Google Sheet</title>
<style>
  :root { font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial; }
  body { margin:24px; line-height:1.6; }
  h2 { margin:0 0 12px; }
  .grid { display:grid; grid-template-columns:160px 1fr; gap:10px 14px; align-items:start; }
  .card { border:1px solid #e5e7eb; border-radius:12px; padding:16px; margin-top:16px; }
  .muted { color:#6b7280; font-size:.92em; }
  .warn { color:#92400e; }
  .ok { color:#065f46; }
  .mono { font-family: ui-monospace,Menlo,Consolas,monospace; }
  .btn { display:inline-block; padding:10px 14px; border-radius:10px; border:1px solid #e5e7eb; cursor:pointer; background:#fff; }
  .btn:hover { background:#f9fafb; }
  input[type="text"], input[type="datetime-local"], textarea, select { width:100%; padding:10px; border:1px solid #e5e7eb; border-radius:10px; }
  textarea { resize:vertical; }
  .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
  .half { width:calc(50% - 6px); min-width:240px; }
  .mapframe { width:100%; height:260px; border:0; border-radius:12px; }
  .prog { width:100%; height:12px; border-radius:8px; background:#eee; overflow:hidden; }
  .bar { height:100%; width:0%; background:#4f46e5; transition:width .2s; }
  .pill { display:inline-block; padding:4px 8px; border:1px solid #e5e7eb; border-radius:999px; font-size:12px; color:#374151; }
  .small { font-size:12px; }
</style>
<!-- Google Identity Services -->
<script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
  <h2>📤 YouTube 續傳上傳（品牌頻道）＋ 回寫 Google Sheet</h2>
  <p class="muted">流程：登入 → 選影片（自動解析並填入拍攝時間/座標）→ 補欄位 → 按「開始上傳」。支援中斷後續傳。</p>

  <!-- 1. 授權 -->
  <div class="card">
    <div class="grid">
      <div>步驟一：登入</div>
      <div>
        <div class="row">
          <button id="btnAuth" class="btn">Google 登入 / 取得授權</button>
          <span class="pill">Scopes：youtube.upload + youtube</span>
        </div>
        <div id="channelInfo" class="muted" style="margin-top:6px">尚未授權。</div>
      </div>

      <div>步驟二：選影片</div>
      <div>
        <input id="file" type="file" accept="video/*">
        <div class="muted">建議從「檔案（Files）」挑原始 .MOV／.MP4；相簿直傳可能無定位。</div>
        <div id="resumeHint" class="small muted" style="margin-top:6px; display:none;"></div>
        <div class="row" style="margin-top:6px;">
          <button id="btnClearResume" class="btn small" style="display:none;">清除續傳紀錄</button>
        </div>
      </div>

      <div>解析結果</div>
      <div>
        <div id="parseBox" class="muted">尚未解析。</div>
        <div class="row" style="margin-top:8px;">
          <span class="muted">已自動將解析到的拍攝時間與座標填入欄位（可手動修改）。</span>
          <button id="btnGeo" class="btn">（可選）取目前位置作為備援</button>
          <span id="geoInfo" class="muted"></span>
        </div>
      </div>
    </div>
  </div>

  <!-- 2. 欄位 -->
  <div class="card">
    <div class="grid">
      <div>片名</div>
      <div><input id="title" type="text" placeholder="輸入片名"></div>

      <div>描述</div>
      <div><textarea id="desc" rows="3" placeholder="輸入描述"></textarea></div>

      <div>分類（自訂）</div>
      <div><input id="category" type="text" placeholder="例如：旅遊Vlog / 健康日報（寫入 Sheet 的 category）"></div>

      <div>隱私</div>
      <div>
        <select id="privacy">
          <option value="unlisted">不公開（建議測試）</option>
          <option value="public">公開</option>
          <option value="private">私人</option>
        </select>
      </div>

      <div>拍攝時間（可改）</div>
      <div>
        <input id="takenTime" type="datetime-local">
        <div class="muted">若留白，會用解析到的時間；沒有就留空。</div>
      </div>

      <div>座標（可改）</div>
      <div class="row">
        <input id="lat" class="half" type="text" placeholder="緯度，如 25.033964">
        <input id="lng" class="half" type="text" placeholder="經度，如 121.564468">
      </div>

      <div>寫回 Google Sheet</div>
      <div class="row">
        <label><input id="writeSheet" type="checkbox" checked> 上傳完成後寫入 Sheet（Videos）</label>
        <span class="muted">欄位：upload_time, taken_time, title, desc, lat, lng, category, video_id</span>
      </div>
    </div>
  </div>

  <!-- 3. 上傳 -->
  <div class="card">
    <div class="row">
      <button id="btnUpload" class="btn">🚀 開始上傳（支援續傳）</button>
      <span id="status" class="muted"></span>
    </div>
    <div class="prog" style="margin-top:10px;"><div id="bar" class="bar"></div></div>
    <div id="progressText" class="small muted" style="margin-top:6px;"></div>
    <div id="result" style="margin-top:12px;"></div>
  </div>

<script>
/** 需替換：你的 Google OAuth Client ID 與 GAS WebApp URL */
const CLIENT_ID = '783633103016-3e7u1n8vpt9essjnct4dirije16u8b23.apps.googleusercontent.com';
const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwiY2z03BuBVk39wgCTgTT_lfMvV4qnoUXqil0yfSOKOFXglqKMrKCRsZeFsxYZLy-1/exec';

/** 續傳設定 */
const CHUNK_SIZE = 8 * 1024 * 1024; // 8MB；256KB 的倍數
const RESUME_PREFIX = 'ytResumable:'; // localStorage key 前綴

let tokenClient, accessToken = null;
let parsedMeta = { creation: null, location: null };
let currentChannel = null;

const scopes = 'https://www.googleapis.com/auth/youtube.upload https://www.googleapis.com/auth/youtube';

const el = (id)=>document.getElementById(id);
const chInfo=el('channelInfo'), parseBox=el('parseBox'), geoInfo=el('geoInfo'), result=el('result');
const btnAuth=el('btnAuth'), btnGeo=el('btnGeo'), btnUpload=el('btnUpload');
const fileInput=el('file'), titleEl=el('title'), descEl=el('desc'), catEl=el('category'), privacyEl=el('privacy');
const takenEl=el('takenTime'), latEl=el('lat'), lngEl=el('lng'), writeSheetEl=el('writeSheet');
const bar=el('bar'), statusEl=el('status'), progressText=el('progressText');
const resumeHint=el('resumeHint'), btnClearResume=el('btnClearResume');

window.onload = () => {
  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: CLIENT_ID,
    scope: scopes,
    prompt: 'consent',
    callback: (resp) => {
      if (resp.error) { alert('授權失敗：' + resp.error); return; }
      accessToken = resp.access_token;
      fetchChannel();
    }
  });

  btnAuth.addEventListener('click', () => tokenClient.requestAccessToken());
  fileInput.addEventListener('change', onChooseFile);
  btnGeo.addEventListener('click', getGeolocation);
  btnUpload.addEventListener('click', startUpload);
  btnClearResume.addEventListener('click', () => {
    const f = fileInput.files?.[0];
    if (!f) return;
    clearResume(getFileId(f));
    updateResumeUI(f);
  });
};

/** 顯示目前綁定的 YouTube 頻道 */
async function fetchChannel(){
  try{
    const res = await fetch('https://www.googleapis.com/youtube/v3/channels?part=snippet&mine=true', {
      headers: { Authorization: 'Bearer ' + accessToken }
    });
    const data = await res.json();
    if (data?.items?.length){
      const ch = data.items[0];
      currentChannel = { id: ch.id, title: ch.snippet.title };
      chInfo.innerHTML = `已授權頻道：<b>${escapeHtml(ch.snippet.title)}</b>（ID: <span class="mono">${ch.id}</span>）`;
    } else {
      chInfo.textContent = '找不到授權頻道，請確認登入時選對品牌頻道。';
    }
  }catch(e){
    chInfo.textContent = '查詢頻道失敗：' + e;
  }
}

/** 選檔後：解析 + 自動填入欄位（拍攝時間/座標） */
async function onChooseFile(){
  resetProgressUI();
  result.innerHTML = '';
  parseBox.textContent = '解析影片中繼資料…';

  const f = fileInput.files?.[0];
  if (!f){ parseBox.textContent = '尚未解析。'; return; }

  // 預填標題
  if (!titleEl.value) titleEl.value = (f.name || '').replace(/\.[^.]+$/, '');

  // 解析 metadata
  const meta = await extractVideoMeta(f);
  parsedMeta = meta;

  // ✅ 解析完成後，自動把拍攝時間/座標填入欄位（可手動再改；若未解析到則不動原值）
  applyParsedToFields(meta);

  // 顯示解析結果
  let html = `<div class="ok">✅ 解析完成</div>
              <div>檔名：<span class="mono">${escapeHtml(f.name)}</span>（${Math.round(f.size/1024/1024)} MB）</div>`;
  if (meta.creation) html += `<div>拍攝時間（解析）：${escapeHtml(meta.creation)}</div>`;
  else html += `<div class="warn">未解析到拍攝時間（可能被移除）</div>`;
  if (meta.location){
    const {lat,lng,alt}=meta.location;
    html += `<div>座標（解析）：${lat.toFixed(6)}, ${lng.toFixed(6)}${alt!=null?`, 海拔 ${alt.toFixed(1)}m`:''}</div>
             <iframe class="mapframe" loading="lazy" src="https://maps.google.com/maps?q=${lat},${lng}&z=15&output=embed"></iframe>`;
  }else{
    html += `<div class="warn">未解析到座標（可能被移除）</div>`;
  }
  parseBox.innerHTML = html;

  updateResumeUI(f);
}

/** 一鍵自動帶入（若解析到才填；不覆蓋你已手動輸入的值） */
function applyParsedToFields(meta){
  if (meta.creation && !takenEl.value){
    const d = new Date(meta.creation);
    if (!isNaN(d)) takenEl.value = toLocalDatetimeInputValue(d);
  }
  if (meta.location){
    if (!latEl.value) latEl.value = String(meta.location.lat);
    if (!lngEl.value) lngEl.value = String(meta.location.lng);
  }
}

/** 更新續傳提示 UI */
function updateResumeUI(file){
  const info = getResume(getFileId(file));
  if (info && info.uploadUrl){
    resumeHint.style.display = '';
    btnClearResume.style.display = '';
    resumeHint.textContent = '偵測到先前未完成的上傳，按「開始上傳」將自動續傳（或可清除續傳紀錄重來）。';
  } else {
    resumeHint.style.display = 'none';
    btnClearResume.style.display = 'none';
    resumeHint.textContent = '';
  }
}

/** 取得目前位置作為備援（填入欄位） */
function getGeolocation(){
  if (!navigator.geolocation) return alert('此瀏覽器不支援定位');
  navigator.geolocation.getCurrentPosition(
    pos => {
      const { latitude, longitude } = pos.coords;
      latEl.value = latitude.toFixed(6);
      lngEl.value = longitude.toFixed(6);
      geoInfo.textContent = `已填入目前位置：${latEl.value}, ${lngEl.value}`;
    },
    err => alert('定位失敗：' + err.message),
    { enableHighAccuracy:true, timeout:15000 }
  );
}

/** 上傳流程（分段續傳） */
async function startUpload(){
  const f = fileInput.files?.[0];
  if (!f) return alert('請先選擇影片');
  if (!accessToken) return alert('請先登入取得授權');

  disableUI(true);
  resetProgressUI();
  setStatus('準備上傳…');

  try{
    // 建立或復用續傳 session
    const fileId = getFileId(f);
    let { uploadUrl } = getOrCreateResume(fileId);

    if (!uploadUrl){
      // 新 session
      const initBody = buildInitBody(f);
      uploadUrl = await startResumableSession(initBody, f);
      saveResume(fileId, uploadUrl);
    }

    // 查詢伺服器目前已收的位移
    let offset = await queryUploadOffset(uploadUrl, f.size);

    // 實際分段上傳
    const videoId = await uploadInChunks(uploadUrl, f, offset, (sent, total) => {
      const pct = Math.floor(sent / total * 100);
      setProgress(pct);
      progressText.textContent = `${formatBytes(sent)} / ${formatBytes(total)} (${pct}%)`;
      setStatus('上傳中…');
    });

    if (!videoId) throw new Error('未取得 videoId');

    setStatus('處理完成，回寫 Google Sheet…');
    setProgress(98);

    const takenISO = getTakenISO();
    const hasLoc = hasLocation();
    const lat = parseFloat(latEl.value), lng = parseFloat(lngEl.value);

    if (writeSheetEl.checked){
      await writeToGAS({
        upload_time: new Date().toISOString(),
        taken_time: takenISO || '',
        title: titleEl.value?.trim() || f.name,
        desc:  descEl.value || '',
        lat: hasLoc ? lat : '',
        lng: hasLoc ? lng : '',
        category: catEl.value || '',
        video_id: videoId
      });
    }

    setProgress(100);
    result.innerHTML = `<div class="ok">✅ 上傳完成：<a target="_blank" href="https://youtu.be/${videoId}">https://youtu.be/${videoId}</a></div>`;
    setStatus('完成');

    // 清除續傳紀錄 & 重置欄位
    clearResume(fileId);
    resetForm();
  }catch(e){
    setStatus('上傳中斷或失敗（可稍後續傳）');
    result.innerHTML = `<div class="warn">❌ 發生錯誤：${escapeHtml(String(e))}</div>`;
  }finally{
    disableUI(false);
    updateResumeUI(fileInput.files?.[0] || null);
  }
}

/** 建立初始化 body（帶 recordingDetails） */
function buildInitBody(file){
  const title = titleEl.value?.trim() || file.name;
  const desc  = descEl.value || '';
  const privacy = privacyEl.value || 'unlisted';
  const meta = { snippet:{ title, description: desc, categoryId:'22' }, status:{ privacyStatus: privacy } };

  const takenISO = getTakenISO();
  const hasLoc = hasLocation();
  if (takenISO || hasLoc){
    meta.recordingDetails = {};
    if (takenISO) meta.recordingDetails.recordingDate = takenISO;
    if (hasLoc){
      meta.recordingDetails.location = {
        latitude: parseFloat(latEl.value), longitude: parseFloat(lngEl.value), altitude: 0
      };
    }
  }
  return meta;
}

/** 取得欄位或解析的拍攝時間（ISO） */
function getTakenISO(){
  if (takenEl.value){
    const d = new Date(takenEl.value);
    if (!isNaN(d)) return d.toISOString();
  } else if (parsedMeta.creation) {
    return parsedMeta.creation;
  }
  return '';
}
function hasLocation(){
  const lat = parseFloat(latEl.value), lng = parseFloat(lngEl.value);
  return !isNaN(lat) && !isNaN(lng);
}

/** 1) 啟動 resumable session ，取得 uploadUrl */
async function startResumableSession(initBody, file){
  const initRes = await fetch('https://www.googleapis.com/upload/youtube/v3/videos?uploadType=resumable&part=snippet,status,recordingDetails', {
    method:'POST',
    headers:{
      Authorization: 'Bearer '+accessToken,
      'Content-Type': 'application/json; charset=UTF-8',
      'X-Upload-Content-Length': file.size,
      'X-Upload-Content-Type': file.type || 'video/*'
    },
    body: JSON.stringify(initBody)
  });
  if (!initRes.ok){
    const t = await initRes.text();
    throw new Error('初始化失敗：'+t);
  }
  const uploadUrl = initRes.headers.get('Location');
  if (!uploadUrl) throw new Error('未取得續傳 URL');
  return uploadUrl;
}

/** 2) 詢問目前已上傳位移（空 PUT） */
async function queryUploadOffset(uploadUrl, totalSize){
  const res = await fetch(uploadUrl, {
    method: 'PUT',
    headers: {
      'Content-Range': 'bytes */' + totalSize,
      'Content-Length': '0'
    }
  });
  if (res.status === 308){
    const range = res.headers.get('Range');
    if (range){
      const m = range.match(/bytes=(\d+)-(\d+)/);
      if (m) return parseInt(m[2], 10) + 1;
    }
    return 0;
  }
  if (res.ok) return totalSize; // 已完成
  return 0;
}

/** 3) 以固定 chunk 大小續傳直到完成 */
async function uploadInChunks(uploadUrl, file, startOffset, onProgress){
  let offset = startOffset || 0;
  const total = file.size;

  while (offset < total){
    const end = Math.min(offset + CHUNK_SIZE, total) - 1;
    const chunk = file.slice(offset, end + 1);
    const res = await fetch(uploadUrl, {
      method: 'PUT',
      headers: {
        'Content-Type': file.type || 'application/octet-stream',
        'Content-Length': String(end - offset + 1),
        'Content-Range': `bytes ${offset}-${end}/${total}`
      },
      body: chunk
    });

    if (res.status === 308){
      const range = res.headers.get('Range');
      if (range){
        const m = range.match(/bytes=(\d+)-(\d+)/);
        offset = m ? (parseInt(m[2], 10) + 1) : (end + 1);
      } else {
        offset = end + 1;
      }
      onProgress && onProgress(offset, total);
      continue;
    }

    const txt = await res.text();
    if (res.ok){
      const json = safeJson(txt);
      return json?.id || null;
    }
    throw new Error(`上傳失敗（HTTP ${res.status}）：${txt.slice(0,300)}`);
  }
  return null;
}

/** 4) 寫回 GAS WebApp（用 text/plain 避免預檢） */
async function writeToGAS(payload){
  const r = await fetch(GAS_WEB_APP_URL, {
    method:'POST',
    headers:{ 'Content-Type':'text/plain;charset=utf-8' },
    body: JSON.stringify(payload)
  });
  const text = await r.text();
  let j; try{ j = JSON.parse(text); }
  catch { throw new Error('GAS 回傳不是 JSON：\n' + text.slice(0,500)); }
  if (!r.ok || !j.ok) throw new Error(j.error || `HTTP ${r.status}`);
  return j;
}

/** —— 續傳資訊 —— */
function getFileId(file){ return `${file.name}_${file.size}_${file.lastModified}`; }
function getResumeKey(fileId){ return RESUME_PREFIX + fileId; }
function getResume(fileId){
  try { return JSON.parse(localStorage.getItem(getResumeKey(fileId)) || 'null') || null; }
  catch { return null; }
}
function saveResume(fileId, uploadUrl){
  localStorage.setItem(getResumeKey(fileId), JSON.stringify({ uploadUrl, updated: Date.now() }));
}
function clearResume(fileId){ localStorage.removeItem(getResumeKey(fileId)); }
function getOrCreateResume(fileId){
  return getResume(fileId) || { uploadUrl: null };
}

/** —— UI helpers —— */
function setStatus(msg){ statusEl.textContent = msg; }
function setProgress(p){ bar.style.width = Math.max(0, Math.min(100, p)) + '%'; }
function resetProgressUI(){ setProgress(0); progressText.textContent = ''; setStatus(''); }
function disableUI(dis){
  [btnAuth, fileInput, btnGeo, btnUpload, titleEl, descEl, catEl, privacyEl, takenEl, latEl, lngEl, writeSheetEl, btnClearResume]
    .forEach(elm => elm.disabled = !!dis);
}
function resetForm(){
  // 清空欄位與結果、進度條、解析顯示、續傳提示
  fileInput.value = '';
  titleEl.value = '';
  descEl.value = '';
  catEl.value = '';
  privacyEl.value = 'unlisted';
  takenEl.value = '';
  latEl.value = '';
  lngEl.value = '';
  writeSheetEl.checked = true;
  parsedMeta = { creation: null, location: null };
  parseBox.textContent = '尚未解析。';
  resumeHint.style.display = 'none';
  btnClearResume.style.display = 'none';
  result.innerHTML = '';
  resetProgressUI();
}
function toLocalDatetimeInputValue(d){ const pad=n=>String(n).padStart(2,'0'); const y=d.getFullYear(), m=pad(d.getMonth()+1), da=pad(d.getDate()), h=pad(d.getHours()), mi=pad(d.getMinutes()); return `${y}-${m}-${da}T${h}:${mi}`; }
function safeJson(t){ try{ return JSON.parse(t);}catch{ return {}; } }
function escapeHtml(s){ return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#39;'); }
function formatBytes(b){ if (b < 1024) return `${b} B`; const u=['KB','MB','GB','TB']; let i=-1; do{ b/=1024; i++; }while(b>=1024 && i<u.length-1); return `${b.toFixed(1)} ${u[i]}`; }

/** —— 影片中繼資料解析 —— */
async function extractVideoMeta(file){
  const headSize = Math.min(file.size, 8*1024*1024);
  const headBuf  = await file.slice(0, headSize).arrayBuffer();
  let text = safeDecode(headBuf);
  let loc = findISO6709(text), cdate = findCreationDate(text);
  if ((!loc || !cdate) && headSize < file.size){
    const fullBuf = await file.arrayBuffer();
    text = safeDecode(fullBuf);
    if (!loc)   loc   = findISO6709(text);
    if (!cdate) cdate = findCreationDate(text);
  }
  if (!loc)   loc   = findAfterKey(text, 'com.apple.quicktime.location.ISO6709');
  if (!cdate) cdate = findAfterKey(text, 'com.apple.quicktime.creationdate') || findAfterKey(text, '©day');
  return {
    creation: normalizeDateTime(cdate) || null,
    location: loc ? iso6709ToLatLng(loc) : null
  };
}
function findISO6709(s){ const re=/[+-]\d{1,2}\.\d{3,}[+-]\d{1,3}\.\d{3,}(?:[+-]\d{1,3}\.\d+)?\/?/; const m=s.match(re); return m?m[0]:null; }
function findAfterKey(s,key){ const i=s.indexOf(key); if(i===-1) return null; const t=s.slice(i+key.length,i+key.length+200);
  const tm=t.match(/\d{4}-\d{2}-\d{2}[ T]\d{2}:\d{2}:\d{2}(?:\.\d+)?Z?/); if(tm) return tm[0];
  const lm=t.match(/[+-]\d{1,2}\.\d{3,}[+-]\d{1,3}\.\d{3,}(?:[+-]\d{1,3}\.\d+)?\/?/); if(lm) return lm[0];
  const pr=t.match(/[\x20-\x7E]{6,}/); return pr?pr[0].trim():null; }
function findCreationDate(s){ let m=s.match(/\d{4}-\d{2}-\d{2}[ T]\d{2}:\d{2}:\d{2}(?:\.\d+)?Z?/); if(m) return m[0]; m=s.match(/\d{4}:\d{2}:\d{2}\s\d{2}:\d{2}:\d{2}/); return m?m[0]:null; }
function iso6709ToLatLng(str){ const re=/^([+-]\d{1,2}\.\d+)([+-]\d{1,3}\.\d+)([+-]\d{1,3}\.\d+)?\/?$/; const m=str.match(re); if(!m) return null;
  return {lat:parseFloat(m[1]), lng:parseFloat(m[2]), alt:m[3]?parseFloat(m[3]):null}; }
function normalizeDateTime(s){ if(!s) return null;
  if(/^\d{4}-\d{2}-\d{2}[ T]\d{2}:\d{2}:\d{2}/.test(s)){ const t=s.replace(' ','T'); try{ return new Date(t).toISOString(); }catch{} }
  if(/^\d{4}:\d{2}:\d{2}\s\d{2}:\d{2}:\d{2}$/.test(s)){ const t=s.replace(/^(\d{4}):(\d{2}):(\d{2})\s/,'$1-$2-$3T')+'Z'; try{ return new Date(t).toISOString(); }catch{} }
  return s;
}
function safeDecode(buf){
  try{ return new TextDecoder('utf-8',{fatal:false}).decode(buf);}
  catch{
    let s=''; const c=1<<20;
    for(let i=0;i<buf.byteLength;i+=c){
      const view=new DataView(buf,i,Math.min(c,buf.byteLength-i));
      const arr=new Uint8Array(view.buffer,view.byteOffset,view.byteLength);
      s+=new TextDecoder('utf-8',{fatal:false}).decode(arr);
    }
    return s;
  }
}
</script>
</body>
</html>
