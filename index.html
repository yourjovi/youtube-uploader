<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å½±ç‰‡æ‹æ”æ™‚é–“èˆ‡åº§æ¨™è§£æ</title>
  <style>
    :root { font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji"; }
    body { margin: 24px; line-height: 1.6; }
    .card { border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px; margin-top: 16px; }
    .muted { color: #6b7280; font-size: 0.9em; }
    .row { display: grid; grid-template-columns: 140px 1fr; gap: 8px 12px; align-items: start; }
    .ok { color: #065f46; }
    .warn { color: #92400e; }
    code { background: #f3f4f6; padding: 2px 6px; border-radius: 6px; }
    .btn { display:inline-block; padding:10px 14px; border-radius:10px; border:1px solid #e5e7eb; cursor:pointer; }
    .btn:hover { background:#f9fafb; }
    .small { font-size: 0.92em; }
    .mono { font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace; }
    .mapframe { width:100%; height:320px; border:0; border-radius:12px; }
  </style>
</head>
<body>
  <h2>ğŸ“¹ è§£æ iPhone å½±ç‰‡çš„æ‹æ”æ™‚é–“èˆ‡åº§æ¨™</h2>
  <p class="muted">
    è‹¥å¾ iPhoneã€Œç›¸ç°¿ã€ç›´æ¥é¸å–ï¼Œç³»çµ±å¯èƒ½ç‚ºäº†éš±ç§ç§»é™¤å®šä½è³‡è¨Šã€‚<br>
    <b>å»ºè­°</b>ï¼šåœ¨ç›¸ç°¿ä¸­å…ˆã€Œ<b>å­˜åˆ°æª”æ¡ˆ</b>ã€ï¼Œå†å¾æœ¬é é¸æ“‡ã€Œæª”æ¡ˆï¼ˆFilesï¼‰ã€æŒ‘åŸå§‹ .MOVï¼.MP4ã€‚
  </p>

  <div class="card">
    <div class="row">
      <div>é¸æ“‡å½±ç‰‡</div>
      <div>
        <input id="file" type="file" accept="video/*" />
        <div class="muted small">å»ºè­°é¸ã€Œæª”æ¡ˆï¼ˆFilesï¼‰ã€è£¡çš„åŸå§‹ .MOVï¼.MP4ï¼›æˆ–å…ˆåœ¨ç›¸ç°¿ä¸­ã€Œå„²å­˜åˆ°æª”æ¡ˆã€ã€‚</div>
      </div>

      <div>å¿«é€Ÿå®šä½</div>
      <div>
        <button id="btnGeo" class="btn small" type="button">ï¼ˆå‚™æ´ï¼‰å–å¾—ç›®å‰ä½ç½®</button>
        <div class="muted small">è‹¥å½±ç‰‡å…§ç„¡åº§æ¨™ï¼Œå¯æŠŠã€Œä¸Šå‚³ç•¶ä¸‹çš„ä½ç½®ã€ç•¶ä½œå‚™æ´æ¨™è¨˜ã€‚</div>
      </div>
    </div>
  </div>

  <div id="result" class="card" style="display:none;"></div>

  <script>
    const fileInput = document.getElementById('file');
    const resultEl  = document.getElementById('result');
    const btnGeo    = document.getElementById('btnGeo');

    // é¸æª”å¾Œè§£æ
    fileInput.addEventListener('change', async (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file) return;

      resultEl.style.display = 'block';
      resultEl.innerHTML = `<div class="muted">æ­£åœ¨è®€å–ï¼š<span class="mono">${escapeHtml(file.name)}</span>ï¼ˆ${Math.round(file.size/1024/1024)} MBï¼‰â€¦</div>`;

      try {
        const meta = await extractVideoMeta(file);
        render(meta, file);
      } catch (err) {
        console.error(err);
        resultEl.innerHTML = `<div class="warn">è®€å–ç™¼ç”ŸéŒ¯èª¤ï¼š${escapeHtml(String(err))}</div>`;
      }
    });

    // å‚™æ´å®šä½ï¼ˆéœ€ HTTPSï¼›GitHub Pages é è¨­ç‚º HTTPSï¼‰
    btnGeo.addEventListener('click', () => {
      if (!navigator.geolocation) {
        alert('æ­¤ç€è¦½å™¨ä¸æ”¯æ´ Geolocation API');
        return;
      }
      navigator.geolocation.getCurrentPosition(
        pos => {
          const { latitude, longitude } = pos.coords;
          const geoHtml = `
            <div class="ok">âœ… å·²å–å¾—ç›®å‰ä½ç½®ï¼ˆå‚™æ´ï¼‰</div>
            <div class="row"><div>åº§æ¨™</div><div>${latitude.toFixed(6)}, ${longitude.toFixed(6)}</div></div>
            <div class="row"><div>åœ°åœ–</div><div>
              <a target="_blank" href="https://www.google.com/maps?q=${latitude},${longitude}">åœ¨ Google åœ°åœ–é–‹å•Ÿ</a>
            </div></div>
            <iframe class="mapframe" loading="lazy"
              src="https://maps.google.com/maps?q=${latitude},${longitude}&z=15&output=embed"></iframe>
            <div class="muted small">æ­¤ç‚ºã€Œä¸Šå‚³æ™‚ä½ç½®ã€ï¼Œéå½±ç‰‡æ‹æ”ä½ç½®ã€‚</div>
          `;
          appendToResult(geoHtml);
        },
        err => alert('å–å¾—ä½ç½®å¤±æ•—ï¼š' + err.message),
        { enableHighAccuracy: true, timeout: 15000 }
      );
    });

    // ---- æ ¸å¿ƒè§£æ ----
    async function extractVideoMeta(file) {
      // å…ˆè®€å‰ 8 MBï¼›æ‰¾ä¸åˆ°å†è®€æ•´æª”ï¼ˆé¿å…å·¨æª”è€—è¨˜æ†¶é«”ï¼‰
      const headSize = Math.min(file.size, 8 * 1024 * 1024);
      const headBuf  = await file.slice(0, headSize).arrayBuffer();
      let text = safeDecode(headBuf);

      let loc = findISO6709(text);
      let cdate = findCreationDate(text);

      if ((!loc || !cdate) && headSize < file.size) {
        const fullBuf = await file.arrayBuffer();
        text = safeDecode(fullBuf);
        if (!loc)   loc   = findISO6709(text);
        if (!cdate) cdate = findCreationDate(text);
      }

      if (!loc)   loc   = findAfterKey(text, 'com.apple.quicktime.location.ISO6709');
      if (!cdate) cdate = findAfterKey(text, 'com.apple.quicktime.creationdate') || findAfterKey(text, 'Â©day');

      return {
        location: loc ? iso6709ToLatLng(loc) : null,
        rawISO6709: loc || null,
        creation: normalizeDateTime(cdate) || null,
        hints: { hadLocation: !!loc, hadCreation: !!cdate }
      };
    }

    // æ‰¾ ISO 6709ï¼ˆä¾‹ï¼š+24.123456+121.123456/ æˆ– +24.1+121.2+012.3/ï¼‰
    function findISO6709(s) {
      const re = /[+-]\d{1,2}\.\d{3,}[+-]\d{1,3}\.\d{3,}(?:[+-]\d{1,3}\.\d+)?\/?/;
      const m = s.match(re);
      return m ? m[0] : null;
    }

    function findAfterKey(s, key) {
      const idx = s.indexOf(key);
      if (idx === -1) return null;
      const tail = s.slice(idx + key.length, idx + key.length + 200);
      const timeMatch = tail.match(/\d{4}-\d{2}-\d{2}[ T]\d{2}:\d{2}:\d{2}(?:\.\d+)?Z?/);
      if (timeMatch) return timeMatch[0];
      const locMatch = tail.match(/[+-]\d{1,2}\.\d{3,}[+-]\d{1,3}\.\d{3,}(?:[+-]\d{1,3}\.\d+)?\/?/);
      if (locMatch) return locMatch[0];
      const printable = tail.match(/[\x20-\x7E]{6,}/);
      return printable ? printable[0].trim() : null;
    }

    function findCreationDate(s) {
      let m = s.match(/\d{4}-\d{2}-\d{2}[ T]\d{2}:\d{2}:\d{2}(?:\.\d+)?Z?/);
      if (m) return m[0];
      m = s.match(/\d{4}:\d{2}:\d{2}\s\d{2}:\d{2}:\d{2}/); // QuickTime Â©day
      if (m) return m[0];
      return null;
    }

    function iso6709ToLatLng(str) {
      const re = /^([+-]\d{1,2}\.\d+)([+-]\d{1,3}\.\d+)([+-]\d{1,3}\.\d+)?\/?$/;
      const m = str.match(re);
      if (!m) return null;
      return {
        lat: parseFloat(m[1]),
        lng: parseFloat(m[2]),
        alt: m[3] ? parseFloat(m[3]) : null
      };
    }

    function normalizeDateTime(s) {
      if (!s) return null;
      if (/^\d{4}-\d{2}-\d{2}[ T]\d{2}:\d{2}:\d{2}/.test(s)) {
        const t = s.replace(' ', 'T');
        try { return new Date(t).toISOString(); } catch {}
      }
      if (/^\d{4}:\d{2}:\d{2}\s\d{2}:\d{2}:\d{2}$/.test(s)) {
        const t = s.replace(/^(\d{4}):(\d{2}):(\d{2})\s/, '$1-$2-$3T') + 'Z';
        try { return new Date(t).toISOString(); } catch {}
      }
      return s;
    }

    function render(meta, file) {
      const hasAny = meta.location || meta.creation;
      const name = escapeHtml(file.name);

      let html = '';
      if (hasAny) {
        html += `<div class="ok">âœ… è§£æå®Œæˆ</div>`;
        html += `<div class="row"><div>æª”å</div><div class="mono">${name}</div></div>`;
        if (meta.creation) {
          html += `<div class="row"><div>æ‹æ”æ™‚é–“</div><div>${escapeHtml(meta.creation)}</div></div>`;
        } else {
          html += `<div class="row"><div>æ‹æ”æ™‚é–“</div><div class="warn">æœªåœ¨æª”å…§æ‰¾åˆ°ï¼ˆå¯èƒ½å·²è¢«ç§»é™¤ï¼‰</div></div>`;
        }
        if (meta.location) {
          const {lat, lng, alt} = meta.location;
          html += `<div class="row"><div>åº§æ¨™</div><div>${lat.toFixed(6)}, ${lng.toFixed(6)}${alt!=null?`, æµ·æ‹” ${alt.toFixed(1)}m`:''}</div></div>`;
          html += `<div class="row"><div>åœ°åœ–</div><div>
            <a target="_blank" href="https://www.google.com/maps?q=${lat},${lng}">åœ¨ Google åœ°åœ–é–‹å•Ÿ</a>
          </div></div>`;
          html += `<iframe class="mapframe" loading="lazy"
            src="https://maps.google.com/maps?q=${lat},${lng}&z=15&output=embed"></iframe>`;
        } else {
          html += `<div class="row"><div>åº§æ¨™</div><div class="warn">æœªåœ¨æª”å…§æ‰¾åˆ°ï¼ˆå¯èƒ½å·²è¢«ç§»é™¤ï¼‰</div></div>`;
          html += `<div class="muted small">å¯å˜—è©¦å¾ã€Œæª”æ¡ˆï¼ˆFilesï¼‰ã€é¸å–åŸå§‹å½±ç‰‡ï¼Œæˆ–ç”¨ä¸Šæ–¹ã€Œï¼ˆå‚™æ´ï¼‰å–å¾—ç›®å‰ä½ç½®ã€ã€‚</div>`;
        }
        if (meta.rawISO6709 && !meta.location) {
          html += `<div class="row"><div>åŸå§‹ ISO6709</div><div class="mono">${escapeHtml(meta.rawISO6709)}</div></div>`;
        }
      } else {
        html += `<div class="warn">æœªèƒ½åœ¨æ­¤å½±ç‰‡ä¸­æ‰¾åˆ°æ‹æ”æ™‚é–“æˆ–åº§æ¨™ã€‚</div>`;
        html += `<ul class="muted">
                  <li>iOS å¯èƒ½å·²ç§»é™¤éš±ç§ä¸­ç¹¼è³‡æ–™ï¼ˆä½ç½®ã€å‰µå»ºæ™‚é–“ï¼‰ã€‚</li>
                  <li>è«‹æ”¹å¾ã€Œæª”æ¡ˆï¼ˆFilesï¼‰ã€æŒ‘é¸åŸå§‹ .MOVï¼.MP4ï¼›æˆ–å…ˆåœ¨ç›¸ç°¿ä¸­ã€Œå­˜åˆ°æª”æ¡ˆã€ã€‚</li>
                  <li>ä¹Ÿå¯é»ä¸Šæ–¹ã€Œï¼ˆå‚™æ´ï¼‰å–å¾—ç›®å‰ä½ç½®ã€ä½œç‚ºä¸Šå‚³ç•¶ä¸‹ä½ç½®ã€‚</li>
                </ul>`;
        html += `<div class="row"><div>æª”å</div><div class="mono">${name}</div></div>`;
        html += `<div class="row"><div>æª”æ¡ˆæ™‚é–“</div><div class="muted">${new Date(file.lastModified).toISOString()}ï¼ˆæª”æ¡ˆçš„æœ€å¾Œä¿®æ”¹æ™‚é–“ï¼Œ<b>ä¸ä¸€å®š</b>æ˜¯æ‹æ”æ™‚é–“ï¼‰</div></div>`;
      }
      resultEl.innerHTML = html;
    }

    function appendToResult(html) {
      resultEl.style.display = 'block';
      resultEl.innerHTML += `<hr style="border:none;border-top:1px dashed #e5e7eb;margin:14px 0;">${html}`;
    }

    function safeDecode(buf) {
      try {
        const decoder = new TextDecoder('utf-8', { fatal: false });
        return decoder.decode(buf);
      } catch {
        let s = '';
        const chunk = 1 << 20;
        for (let i = 0; i < buf.byteLength; i += chunk) {
          const view = new DataView(buf, i, Math.min(chunk, buf.byteLength - i));
          const arr = new Uint8Array(view.buffer, view.byteOffset, view.byteLength);
          s += new TextDecoder('utf-8', { fatal: false }).decode(arr);
        }
        return s;
      }
    }

    function escapeHtml(s) {
      return String(s)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'",'&#39;');
    }
  </script>
</body>
</html>
