<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>æ‰‹æ©Ÿä¸Šå‚³åˆ° YouTube + å›å¯« Google Sheet</title>
<style>
  :root { font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial; }
  body { margin: 24px; line-height: 1.6; }
  .card { border:1px solid #e5e7eb; border-radius:12px; padding:16px; margin-top:16px; }
  .row{ display:grid; grid-template-columns:140px 1fr; gap:8px 12px; align-items:start; }
  .btn{ display:inline-block; padding:10px 14px; border-radius:10px; border:1px solid #e5e7eb; cursor:pointer; }
  .btn:hover{ background:#f9fafb; }
  .ok{ color:#065f46; } .warn{ color:#92400e; } .muted{ color:#6b7280; font-size:.92em; }
  .mono{ font-family: ui-monospace,Menlo,Consolas,monospace; }
  .mapframe { width:100%; height:260px; border:0; border-radius:12px; }
</style>
<script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
<h2>ğŸ“¤ æ‰‹æ©Ÿä¸Šå‚³åˆ° YouTubeï¼ˆå“ç‰Œé »é“ï¼‰ï¼‹ å›å¯« Google Sheet</h2>

<div class="card">
  <div class="row">
    <div>ç™»å…¥ YouTube</div>
    <div>
      <button id="btnAuth" class="btn">Google ç™»å…¥ / å–å¾—æˆæ¬Š</button>
      <div class="muted">æˆæ¬Šç¯„åœï¼š<code>youtube.upload</code>ï¼ˆä¸Šå‚³ï¼‰èˆ‡ <code>youtube</code>ï¼ˆæŸ¥è©¢é »é“ç­‰ï¼‰ã€‚è«‹åœ¨å¸³è™Ÿé¸å–®é¸ä½ çš„å“ç‰Œé »é“ã€‚</div>
      <div id="channelInfo" class="muted"></div>
    </div>

    <div>é¸æ“‡å½±ç‰‡</div>
    <div>
      <input id="file" type="file" accept="video/*">
      <div class="muted">å»ºè­°å¾ã€Œæª”æ¡ˆï¼ˆFilesï¼‰ã€æŒ‘åŸå§‹ .MOVï¼.MP4ï¼›ç›¸ç°¿ç›´å‚³æœ‰æ™‚æœƒè¢« iOS ç§»é™¤ä½ç½®è³‡è¨Šã€‚</div>
    </div>

    <div>ç‰‡å / æè¿°</div>
    <div>
      <input id="title" placeholder="è¼¸å…¥ç‰‡å" style="width:100%;padding:8px">
      <textarea id="desc" placeholder="è¼¸å…¥æè¿°" rows="3" style="width:100%;padding:8px;margin-top:6px"></textarea>
    </div>

    <div>åˆ†é¡ / éš±ç§</div>
    <div>
      <input id="category" placeholder="è‡ªè¨‚åˆ†é¡ï¼ˆå¯«å…¥Sheetç”¨ï¼‰" style="width:100%;padding:8px">
      <select id="privacy" style="width:100%;padding:8px;margin-top:6px">
        <option value="unlisted">ä¸å…¬é–‹ï¼ˆå»ºè­°æ¸¬è©¦ï¼‰</option>
        <option value="public">å…¬é–‹</option>
        <option value="private">ç§äºº</option>
      </select>
    </div>

    <div>å‚™æ´å®šä½</div>
    <div>
      <button id="btnGeo" class="btn">ï¼ˆå¯é¸ï¼‰å–å¾—ç›®å‰ä½ç½®</button>
      <div id="geoInfo" class="muted"></div>
    </div>
  </div>
</div>

<div id="result" class="card" style="display:none;"></div>

<script>
/** â†â†â† ä¾ä½ å°ˆæ¡ˆä¿®æ”¹é€™å…©å€‹å¸¸æ•¸ */
const CLIENT_ID = '783633103016-3e7u1n8vpt9essjnct4dirije16u8b23.apps.googleusercontent.com';
const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbw5fyhFwEHFRbBcDOMBn5Ial3Vgi0YN2nvxfM7YpCL2eB07huq_jWbeEOYpuJbD9g1L/exec';

let tokenClient, accessToken = null;
let currentChannel = null; // {id, title}
const scopes = 'https://www.googleapis.com/auth/youtube.upload https://www.googleapis.com/auth/youtube';

const qs = sel => document.querySelector(sel);
const elFile = qs('#file'), elTitle = qs('#title'), elDesc = qs('#desc');
const elPrivacy = qs('#privacy'), elCategory = qs('#category');
const elBtnAuth = qs('#btnAuth'), elResult = qs('#result'), elChannelInfo = qs('#channelInfo');
const elBtnGeo = qs('#btnGeo'), elGeoInfo = qs('#geoInfo');

window.onload = () => {
  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: CLIENT_ID,
    scope: scopes,
    prompt: 'consent',
    callback: (resp) => {
      if (resp.error) { alert('æˆæ¬Šå¤±æ•—ï¼š' + resp.error); return; }
      accessToken = resp.access_token;
      fetchChannel(); // é¡¯ç¤ºç›®å‰æˆæ¬Šåˆ°å“ªå€‹é »é“ï¼ˆå“ç‰Œå¸³è™Ÿï¼‰
    }
  });

  elBtnAuth.addEventListener('click', () => tokenClient.requestAccessToken());
  elBtnGeo.addEventListener('click', getGeolocation);
  elFile.addEventListener('change', handleFileChosen);
};

async function fetchChannel() {
  try {
    const res = await fetch('https://www.googleapis.com/youtube/v3/channels?part=snippet&mine=true', {
      headers: { Authorization: 'Bearer ' + accessToken }
    });
    const data = await res.json();
    if (data?.items?.length) {
      const ch = data.items[0];
      currentChannel = { id: ch.id, title: ch.snippet.title };
      elChannelInfo.innerHTML = `å·²æˆæ¬Šé »é“ï¼š<b>${escapeHtml(ch.snippet.title)}</b>ï¼ˆID: <span class="mono">${ch.id}</span>ï¼‰`;
    } else {
      elChannelInfo.textContent = 'æ‰¾ä¸åˆ°æˆæ¬Šé »é“ï¼Œè«‹ç¢ºèªå·²é¸å°å“ç‰Œé »é“ã€‚';
    }
  } catch (e) {
    elChannelInfo.textContent = 'æŸ¥è©¢é »é“å¤±æ•—ï¼š' + e;
  }
}

async function handleFileChosen() {
  const file = elFile.files?.[0];
  if (!file) return;

  // å…ˆå˜—è©¦å¾æª”æ¡ˆæŠ“æ‹æ”æ™‚é–“èˆ‡åº§æ¨™
  elResult.style.display = 'block';
  elResult.innerHTML = `<div class="muted">è§£æå½±ç‰‡ä¸­ç¹¼è³‡æ–™ä¸­â€¦</div>`;
  const meta = await extractVideoMeta(file);

  // é å¡«æ¨™é¡Œ
  if (!elTitle.value) elTitle.value = (file.name || '').replace(/\.[^.]+$/, '');

  // é¡¯ç¤ºè§£æçµæœ
  renderMeta(meta, file);

  // ç›´æ¥é–‹å§‹ä¸Šå‚³
  if (!accessToken) {
    alert('è«‹å…ˆé»ã€ŒGoogle ç™»å…¥ / å–å¾—æˆæ¬Šã€');
    return;
  }
  const videoId = await uploadToYouTube(file, meta);
  if (videoId) {
    appendResult(`<div class="ok">âœ… ä¸Šå‚³å®Œæˆï¼ŒYouTube å½±ç‰‡ IDï¼š<b class="mono">${videoId}</b></div>
      <div><a target="_blank" href="https://youtu.be/${videoId}">æ‰“é–‹å½±ç‰‡</a></div>`);
    // å›å¯«åˆ° GAS
    await writeToGAS({
      upload_time: new Date().toISOString(),
      taken_time: meta.creation || '',
      title: elTitle.value || '',
      desc: elDesc.value || '',
      lat: meta.location?.lat ?? '',
      lng: meta.location?.lng ?? '',
      category: elCategory.value || '',
      video_id: videoId
    });
  }
}

/** ---- â‘  ä¸Šå‚³åˆ° YouTubeï¼ˆresumable uploadï¼‰ ---- */
async function uploadToYouTube(file, meta) {
  try {
    // 1) å•Ÿå‹•å¯çºŒå‚³ session
    const body = {
      snippet: {
        title: elTitle.value || file.name,
        description: elDesc.value || '',
        categoryId: '22' // People & Blogsï¼Œä¾éœ€æ±‚èª¿æ•´
      },
      status: { privacyStatus: elPrivacy.value || 'unlisted' }
    };
    // è‹¥æŠ“åˆ°æ‹æ”æ™‚é–“/åº§æ¨™ï¼Œå¸¶åˆ° recordingDetailsï¼ˆå¯é¸ï¼‰
    if (meta.creation || meta.location) {
      body.recordingDetails = {};
      if (meta.creation) body.recordingDetails.recordingDate = meta.creation; // ISO8601
      if (meta.location) {
        body.recordingDetails.location = {
          latitude:  meta.location.lat,
          longitude: meta.location.lng,
          altitude:  meta.location.alt ?? 0
        };
      }
    }

    const initRes = await fetch('https://www.googleapis.com/upload/youtube/v3/videos?uploadType=resumable&part=snippet,status,recordingDetails', {
      method: 'POST',
      headers: {
        Authorization: 'Bearer ' + accessToken,
        'Content-Type': 'application/json; charset=UTF-8',
        'X-Upload-Content-Length': file.size,
        'X-Upload-Content-Type': file.type || 'video/*'
      },
      body: JSON.stringify(body)
    });
    if (!initRes.ok) {
      const t = await initRes.text();
      throw new Error('init å¤±æ•—ï¼š' + t);
    }
    const uploadUrl = initRes.headers.get('Location');
    if (!uploadUrl) throw new Error('æ²’æœ‰æ‹¿åˆ°çºŒå‚³ URL');

    appendResult(`<div class="muted">é–‹å§‹ä¸Šå‚³ï¼ˆ${Math.round(file.size/1024/1024)} MBï¼‰â€¦</div>`);

    // 2) å–®è¶Ÿ PUTï¼ˆæª”æ¡ˆä¸å¤§æ™‚ï¼‰ï¼›è‹¥å¾ˆå¤§å¯æ”¹ç”¨åˆ†æ®µä¸Šå‚³
    const putRes = await fetch(uploadUrl, {
      method: 'PUT',
      headers: { 'Content-Type': file.type || 'application/octet-stream' },
      body: file
    });

    // å¯èƒ½ 200/201 å›å‚³ JSON
    const txt = await putRes.text();
    if (!putRes.ok) throw new Error('ä¸Šå‚³å¤±æ•—ï¼š' + txt);
    const json = safeJson(txt);
    const videoId = json?.id;
    return videoId || null;
  } catch (e) {
    appendResult(`<div class="warn">âŒ ä¸Šå‚³å¤±æ•—ï¼š${escapeHtml(String(e))}</div>`);
    return null;
  }
}

/** ---- â‘¡ å›å¯«åˆ° GASï¼ˆå¯«å…¥ Sheetï¼‰ ---- */
async function writeToGAS(payload) {
  try {
    const r = await fetch(GAS_WEB_APP_URL, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    const j = await r.json();
    if (!j.ok) throw new Error(j.error || 'æœªçŸ¥éŒ¯èª¤');
    appendResult(`<div class="ok">âœ… å·²å¯«å…¥ Google Sheet</div>`);
  } catch (e) {
    appendResult(`<div class="warn">âŒ å›å¯« Sheet å¤±æ•—ï¼š${escapeHtml(String(e))}</div>`);
  }
}

/** ï¼ˆå¯é¸ï¼‰å‚™æ´ï¼šå–å¾—ç›®å‰ä½ç½® */
function getGeolocation() {
  if (!navigator.geolocation) return alert('æ­¤ç€è¦½å™¨ä¸æ”¯æ´å®šä½');
  navigator.geolocation.getCurrentPosition(
    pos => {
      const { latitude, longitude } = pos.coords;
      elGeoInfo.innerHTML = `ç›®å‰ä½ç½®ï¼š<b>${latitude.toFixed(6)}, ${longitude.toFixed(6)}</b>`;
    },
    err => alert('å®šä½å¤±æ•—ï¼š' + err.message),
    { enableHighAccuracy:true, timeout:15000 }
  );
}

/** ---- å½±ç‰‡ä¸­ç¹¼è³‡æ–™è§£æï¼ˆåŒä½ å‰é¢é‚£ç‰ˆï¼Œç•¥å£“ç¸®ï¼‰ ---- */
async function extractVideoMeta(file){
  const headSize = Math.min(file.size, 8*1024*1024);
  const headBuf  = await file.slice(0, headSize).arrayBuffer();
  let text = safeDecode(headBuf);
  let loc = findISO6709(text), cdate = findCreationDate(text);
  if ((!loc || !cdate) && headSize < file.size) {
    const fullBuf = await file.arrayBuffer();
    text = safeDecode(fullBuf);
    if (!loc)   loc   = findISO6709(text);
    if (!cdate) cdate = findCreationDate(text);
  }
  if (!loc)   loc   = findAfterKey(text, 'com.apple.quicktime.location.ISO6709');
  if (!cdate) cdate = findAfterKey(text, 'com.apple.quicktime.creationdate') || findAfterKey(text, 'Â©day');

  return {
    location: loc ? iso6709ToLatLng(loc) : null,
    rawISO6709: loc || null,
    creation: normalizeDateTime(cdate) || null
  };
}
function findISO6709(s){ const re=/[+-]\d{1,2}\.\d{3,}[+-]\d{1,3}\.\d{3,}(?:[+-]\d{1,3}\.\d+)?\/?/; const m=s.match(re); return m?m[0]:null; }
function findAfterKey(s,key){ const i=s.indexOf(key); if(i===-1) return null; const t=s.slice(i+key.length,i+key.length+200);
  const tm=t.match(/\d{4}-\d{2}-\d{2}[ T]\d{2}:\d{2}:\d{2}(?:\.\d+)?Z?/); if(tm) return tm[0];
  const lm=t.match(/[+-]\d{1,2}\.\d{3,}[+-]\d{1,3}\.\d{3,}(?:[+-]\d{1,3}\.\d+)?\/?/); if(lm) return lm[0];
  const pr=t.match(/[\x20-\x7E]{6,}/); return pr?pr[0].trim():null; }
function findCreationDate(s){ let m=s.match(/\d{4}-\d{2}-\d{2}[ T]\d{2}:\d{2}:\d{2}(?:\.\d+)?Z?/); if(m) return m[0]; m=s.match(/\d{4}:\d{2}:\d{2}\s\d{2}:\d{2}:\d{2}/); return m?m[0]:null; }
function iso6709ToLatLng(str){ const re=/^([+-]\d{1,2}\.\d+)([+-]\d{1,3}\.\d+)([+-]\d{1,3}\.\d+)?\/?$/; const m=str.match(re); if(!m) return null;
  return {lat:parseFloat(m[1]), lng:parseFloat(m[2]), alt:m[3]?parseFloat(m[3]):null}; }
function normalizeDateTime(s){ if(!s) return null; if(/^\d{4}-\d{2}-\d{2}[ T]\d{2}:\d{2}:\d{2}/.test(s)){ const t=s.replace(' ','T'); try{return new Date(t).toISOString();}catch{} }
  if(/^\d{4}:\d{2}:\d{2}\s\d{2}:\d{2}:\d{2}$/.test(s)){ const t=s.replace(/^(\d{4}):(\d{2}):(\d{2})\s/,'$1-$2-$3T')+'Z'; try{return new Date(t).toISOString();}catch{} } return s; }
function safeDecode(buf){ try{ return new TextDecoder('utf-8',{fatal:false}).decode(buf);}catch{ let s=''; const c=1<<20; for(let i=0;i<buf.byteLength;i+=c){ const v=new DataView(buf,i,Math.min(c,buf.byteLength-i)); const a=new Uint8Array(v.buffer,v.byteOffset,v.byteLength); s+=new TextDecoder('utf-8',{fatal:false}).decode(a);} return s; } }
function safeJson(t){ try{ return JSON.parse(t);}catch{ return {}; } }
function escapeHtml(s){ return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#39;'); }

function renderMeta(meta, file){
  let html = `<div class="row"><div>æª”å</div><div class="mono">${escapeHtml(file.name)}</div></div>`;
  if (meta.creation) html += `<div class="row"><div>æ‹æ”æ™‚é–“</div><div>${escapeHtml(meta.creation)}</div></div>`;
  else html += `<div class="row"><div>æ‹æ”æ™‚é–“</div><div class="warn">æœªæ‰¾åˆ°ï¼ˆå¯èƒ½è¢«ç§»é™¤ï¼‰</div></div>`;
  if (meta.location){
    const {lat,lng,alt}=meta.location;
    html += `<div class="row"><div>åº§æ¨™</div><div>${lat.toFixed(6)}, ${lng.toFixed(6)}${alt!=null?`, æµ·æ‹” ${alt.toFixed(1)}m`:''}</div></div>
             <iframe class="mapframe" loading="lazy" src="https://maps.google.com/maps?q=${lat},${lng}&z=15&output=embed"></iframe>`;
  } else {
    html += `<div class="row"><div>åº§æ¨™</div><div class="warn">æœªæ‰¾åˆ°ï¼ˆå¯èƒ½è¢«ç§»é™¤ï¼‰</div></div>`;
  }
  elResult.innerHTML = html;
}
function appendResult(html){ elResult.style.display='block'; elResult.innerHTML += `<hr style="border:none;border-top:1px dashed #e5e7eb;margin:14px 0;">${html}`; }
</script>
</body>
</html>
