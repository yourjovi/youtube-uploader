<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>YT å¯çºŒå‚³ä¸Šå‚³ï¼‹å›å¯« Google Sheet</title>
<style>
  :root { font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial; }
  body { margin:24px; line-height:1.6; }
  h2 { margin:0 0 12px; }
  .grid { display:grid; grid-template-columns:160px 1fr; gap:10px 14px; align-items:start; }
  .card { border:1px solid #e5e7eb; border-radius:12px; padding:16px; margin-top:16px; }
  .muted { color:#6b7280; font-size:.92em; }
  .warn { color:#92400e; }
  .ok { color:#065f46; }
  .mono { font-family: ui-monospace,Menlo,Consolas,monospace; }
  .btn { display:inline-block; padding:10px 14px; border-radius:10px; border:1px solid #e5e7eb; cursor:pointer; background:#fff; }
  .btn:hover { background:#f9fafb; }
  input[type="text"], input[type="datetime-local"], textarea, select {
    width:100%; padding:10px; border:1px solid #e5e7eb; border-radius:10px;
  }
  textarea { resize:vertical; }
  .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
  .half { width:calc(50% - 6px); min-width:240px; }
  .mapframe { width:100%; height:260px; border:0; border-radius:12px; }
  .prog { width:100%; height:10px; border-radius:8px; background:#eee; overflow:hidden; }
  .bar { height:100%; width:0%; background:#4f46e5; transition:width .15s linear; }
  .pill { display:inline-block; padding:4px 8px; border:1px solid #e5e7eb; border-radius:999px; font-size:12px; color:#374151; }
</style>
<script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
  <h2>ğŸ“¤ YT å¯çºŒå‚³ä¸Šå‚³ï¼ˆå“ç‰Œé »é“ï¼‰ï¼‹ å›å¯« Google Sheet</h2>
  <p class="muted">æµç¨‹ï¼šç™»å…¥ â†’ é¸å½±ç‰‡ï¼ˆå…ˆè§£æä¸­ç¹¼è³‡æ–™ï¼‰â†’ å¡«å¯«ï¼ä¿®æ­£æ¬„ä½ â†’ æŒ‰ã€Œé–‹å§‹ä¸Šå‚³ã€ã€‚ä¿æŒæœ¬åˆ†é é–‹è‘—å³å¯ï¼Œtoken æœƒè‡ªå‹•çºŒæœŸã€‚</p>

  <!-- 1. æˆæ¬Š -->
  <div class="card">
    <div class="grid">
      <div>æ­¥é©Ÿä¸€ï¼šç™»å…¥</div>
      <div>
        <div class="row">
          <button id="btnAuth" class="btn">Google ç™»å…¥ / å–å¾—æˆæ¬Š</button>
          <span class="pill">Scopesï¼šyoutube.upload + youtube</span>
        </div>
        <div id="channelInfo" class="muted" style="margin-top:6px">å°šæœªæˆæ¬Šã€‚</div>
      </div>

      <div>æ­¥é©ŸäºŒï¼šé¸å½±ç‰‡</div>
      <div>
        <input id="file" type="file" accept="video/*">
        <div class="muted">å»ºè­°å¾ã€Œæª”æ¡ˆï¼ˆFilesï¼‰ã€æŒ‘åŸå§‹ .MOVï¼.MP4ï¼›ç›¸ç°¿ç›´å‚³å¯èƒ½ç„¡å®šä½ã€‚</div>
      </div>

      <div>è§£æçµæœ</div>
      <div>
        <div id="parseBox" class="muted">å°šæœªè§£æã€‚</div>
        <div class="row" style="margin-top:8px;">
          <button id="btnUseParsed" class="btn" disabled>æŠŠè§£æåˆ°çš„æ‹æ”æ™‚é–“/åº§æ¨™å¸¶å…¥æ¬„ä½</button>
          <button id="btnGeo" class="btn">ï¼ˆå¯é¸ï¼‰å–ç›®å‰ä½ç½®ä½œç‚ºå‚™æ´</button>
          <span id="geoInfo" class="muted"></span>
        </div>
      </div>
    </div>
  </div>

  <!-- 2. æ¬„ä½ -->
  <div class="card">
    <div class="grid">
      <div>ç‰‡å</div>
      <div><input id="title" type="text" placeholder="è¼¸å…¥ç‰‡å"></div>

      <div>æè¿°</div>
      <div><textarea id="desc" rows="3" placeholder="è¼¸å…¥æè¿°"></textarea></div>

      <div>åˆ†é¡ï¼ˆè‡ªè¨‚ï¼‰</div>
      <div><input id="category" type="text" placeholder="ä¾‹å¦‚ï¼šæ—…éŠVlog / å¥åº·æ—¥å ±ï¼ˆå¯«å…¥ Sheet çš„ categoryï¼‰"></div>

      <div>éš±ç§</div>
      <div>
        <select id="privacy">
          <option value="unlisted">ä¸å…¬é–‹ï¼ˆå»ºè­°æ¸¬è©¦ï¼‰</option>
          <option value="public">å…¬é–‹</option>
          <option value="private">ç§äºº</option>
        </select>
      </div>

      <div>æ‹æ”æ™‚é–“ï¼ˆå¯æ”¹ï¼‰</div>
      <div>
        <input id="takenTime" type="datetime-local">
        <div class="muted">è‹¥ç•™ç™½ï¼Œæœƒç”¨è§£æåˆ°çš„æ™‚é–“ï¼›æ²’æœ‰å‰‡ç•™ç©ºã€‚</div>
      </div>

      <div>åº§æ¨™ï¼ˆå¯æ”¹ï¼‰</div>
      <div class="row">
        <input id="lat" class="half" type="text" placeholder="ç·¯åº¦ï¼Œå¦‚ 25.033964">
        <input id="lng" class="half" type="text" placeholder="ç¶“åº¦ï¼Œå¦‚ 121.564468">
      </div>

      <div>å¯«å› Google Sheet</div>
      <div class="row">
        <label><input id="writeSheet" type="checkbox" checked> ä¸Šå‚³å®Œæˆå¾Œå¯«å…¥ Sheetï¼ˆVideosï¼‰</label>
        <span class="muted">æ¬„ä½ï¼šupload_time, taken_time, title, desc, lat, lng, category, video_id</span>
      </div>
    </div>
  </div>

  <!-- 3. ä¸Šå‚³ -->
  <div class="card">
    <div class="row">
      <button id="btnUpload" class="btn">ğŸš€ é–‹å§‹ä¸Šå‚³ï¼ˆå¯çºŒå‚³ï¼‰</button>
      <span id="status" class="muted"></span>
    </div>
    <div class="prog" style="margin-top:10px;"><div id="bar" class="bar"></div></div>
    <div id="result" style="margin-top:12px;"></div>
  </div>

<script>
/** â†â†â† æ›æˆä½ çš„è¨­å®š */
const CLIENT_ID = '783633103016-3e7u1n8vpt9essjnct4dirije16u8b23.apps.googleusercontent.com';
const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbz2v1pOkIdH_sYAUoTX6sZacJMfK6uqcDT61slmQN1b5_4G0wGghnPNWXIsv-PcBM14/exec';

/** å¯èª¿åƒæ•¸ */
const CHUNK_SIZE = 8 * 1024 * 1024; // 8 MBï¼ˆiOS Safari ä¹Ÿç©©ï¼‰
const TOKEN_SAFETY_MIN = 120; // å°æ–¼ 120 ç§’åˆ°æœŸå°±å…ˆé»˜é»˜çºŒæœŸ

let tokenClient, accessToken = null, tokenExpiry = 0;
let parsedMeta = { creation: null, location: null };
let currentChannel = null;
const scopes = 'https://www.googleapis.com/auth/youtube.upload https://www.googleapis.com/auth/youtube';

const el = (id)=>document.getElementById(id);
const chInfo=el('channelInfo'), parseBox=el('parseBox'), geoInfo=el('geoInfo'), result=el('result');
const btnAuth=el('btnAuth'), btnUseParsed=el('btnUseParsed'), btnGeo=el('btnGeo'), btnUpload=el('btnUpload');
const fileInput=el('file'), titleEl=el('title'), descEl=el('desc'), catEl=el('category'), privacyEl=el('privacy');
const takenEl=el('takenTime'), latEl=el('lat'), lngEl=el('lng'), writeSheetEl=el('writeSheet');
const bar=el('bar'), statusEl=el('status');

window.onload = () => {
  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: CLIENT_ID,
    scope: scopes,
    prompt: 'consent',
    callback: (resp) => {
      if (resp.error) { alert('æˆæ¬Šå¤±æ•—ï¼š' + resp.error); return; }
      accessToken = resp.access_token;
      // expires_in å¯èƒ½å­˜åœ¨ï¼›è‹¥æ²’æœ‰å°±ä¿å®ˆçµ¦ 50 åˆ†é˜
      const ttl = (resp.expires_in ? Number(resp.expires_in) : 3000);
      tokenExpiry = Date.now()/1000 + ttl;
      fetchChannel();
    }
  });

  btnAuth.addEventListener('click', () => tokenClient.requestAccessToken());
  fileInput.addEventListener('change', onChooseFile);
  btnUseParsed.addEventListener('click', useParsedToFields);
  btnGeo.addEventListener('click', getGeolocation);
  btnUpload.addEventListener('click', startUpload);
};

/** åœ¨åŒä¸€åˆ†é ä¸­ä¿æŒå…é‡ç™»ï¼šåˆ°æœŸå‰è‡ªå‹•é»˜é»˜çºŒæœŸ */
async function ensureAccessToken() {
  const now = Date.now()/1000;
  if (!accessToken || (tokenExpiry - now) < TOKEN_SAFETY_MIN) {
    await new Promise((resolve, reject) => {
      tokenClient.callback = (resp) => {
        if (resp.error) return reject(resp);
        accessToken = resp.access_token;
        const ttl = (resp.expires_in ? Number(resp.expires_in) : 3000);
        tokenExpiry = Date.now()/1000 + ttl;
        resolve();
      };
      tokenClient.requestAccessToken({ prompt: '' }); // éœé»˜çºŒæœŸï¼Œä¸å†è·³é¸å–®
    });
  }
}

async function fetchChannel(){
  try{
    await ensureAccessToken();
    const res = await fetch('https://www.googleapis.com/youtube/v3/channels?part=snippet&mine=true', {
      headers: { Authorization: 'Bearer ' + accessToken }
    });
    const data = await res.json();
    if (data?.items?.length){
      const ch = data.items[0];
      currentChannel = { id: ch.id, title: ch.snippet.title };
      chInfo.innerHTML = `å·²æˆæ¬Šé »é“ï¼š<b>${escapeHtml(ch.snippet.title)}</b>ï¼ˆID: <span class="mono">${ch.id}</span>ï¼‰`;
    } else {
      chInfo.textContent = 'æ‰¾ä¸åˆ°æˆæ¬Šé »é“ï¼Œè«‹ç¢ºèªç™»å…¥æ™‚é¸å°å“ç‰Œé »é“ã€‚';
    }
  }catch(e){
    chInfo.textContent = 'æŸ¥è©¢é »é“å¤±æ•—ï¼š' + e;
  }
}

/** é¸æª”å¾Œï¼šåªåšè§£æèˆ‡é å¡«ï¼Œä¸è‡ªå‹•ä¸Šå‚³ */
async function onChooseFile(){
  const f = fileInput.files?.[0];
  if (!f){ parseBox.textContent = 'å°šæœªè§£æã€‚'; return; }

  if (!titleEl.value) titleEl.value = (f.name || '').replace(/\.[^.]+$/, '');

  parseBox.textContent = 'è§£æå½±ç‰‡ä¸­ç¹¼è³‡æ–™â€¦';
  const meta = await extractVideoMeta(f);
  parsedMeta = meta;

  let html = `<div class="ok">âœ… è§£æå®Œæˆ</div>
              <div>æª”åï¼š<span class="mono">${escapeHtml(f.name)}</span>ï¼ˆ${Math.round(f.size/1024/1024)} MBï¼‰</div>`;
  if (meta.creation) html += `<div>æ‹æ”æ™‚é–“ï¼ˆè§£æï¼‰ï¼š${escapeHtml(meta.creation)}</div>`;
  else html += `<div class="warn">æœªè§£æåˆ°æ‹æ”æ™‚é–“ï¼ˆå¯èƒ½è¢«ç§»é™¤ï¼‰</div>`;
  if (meta.location){
    const {lat,lng,alt}=meta.location;
    html += `<div>åº§æ¨™ï¼ˆè§£æï¼‰ï¼š${lat.toFixed(6)}, ${lng.toFixed(6)}${alt!=null?`, æµ·æ‹” ${alt.toFixed(1)}m`:''}</div>
             <iframe class="mapframe" loading="lazy" src="https://maps.google.com/maps?q=${lat},${lng}&z=15&output=embed"></iframe>`;
  }else{
    html += `<div class="warn">æœªè§£æåˆ°åº§æ¨™ï¼ˆå¯èƒ½è¢«ç§»é™¤ï¼‰</div>`;
  }
  parseBox.innerHTML = html;
  btnUseParsed.disabled = !(meta.creation || meta.location);
}

/** ä¸€éµæŠŠè§£æå€¼å¸¶å…¥å¯ç·¨è¼¯æ¬„ä½ */
function useParsedToFields(){
  if (parsedMeta.creation){
    const d = new Date(parsedMeta.creation);
    if (!isNaN(d)) takenEl.value = toLocalDatetimeInputValue(d);
  }
  if (parsedMeta.location){
    latEl.value = parsedMeta.location.lat.toString();
    lngEl.value = parsedMeta.location.lng.toString();
  }
}

/** å–å¾—ç›®å‰ä½ç½®ä½œç‚ºå‚™æ´ */
function getGeolocation(){
  if (!navigator.geolocation) return alert('æ­¤ç€è¦½å™¨ä¸æ”¯æ´å®šä½');
  navigator.geolocation.getCurrentPosition(
    pos => {
      const { latitude, longitude } = pos.coords;
      latEl.value = latitude.toFixed(6);
      lngEl.value = longitude.toFixed(6);
      geoInfo.textContent = `å·²å¡«å…¥ç›®å‰ä½ç½®ï¼š${latEl.value}, ${lngEl.value}`;
    },
    err => alert('å®šä½å¤±æ•—ï¼š' + err.message),
    { enableHighAccuracy:true, timeout:15000 }
  );
}

/** æŒ‰éˆ•ï¼šé–‹å§‹ä¸Šå‚³ï¼ˆå¯çºŒå‚³ï¼‰ */
async function startUpload(){
  const f = fileInput.files?.[0];
  if (!f) return alert('è«‹å…ˆé¸æ“‡å½±ç‰‡');

  await ensureAccessToken();

  // çµ„ metadata
  const title = titleEl.value?.trim() || f.name;
  const desc  = descEl.value || '';
  const category = catEl.value || '';
  const privacy = privacyEl.value || 'unlisted';

  let takenISO = '';
  if (takenEl.value){
    const d = new Date(takenEl.value);
    if (!isNaN(d)) takenISO = d.toISOString();
  } else if (parsedMeta.creation) {
    takenISO = parsedMeta.creation;
  }

  const lat = parseFloat(latEl.value);
  const lng = parseFloat(lngEl.value);
  const hasLoc = !isNaN(lat) && !isNaN(lng);

  // 1) å»ºç«‹ Resumable Sessionï¼ˆæ‹¿åˆ° uploadUrlï¼‰
  disableUI(true);
  setProgress(0); setStatus('å»ºç«‹ä¸Šå‚³é€£ç·šâ€¦');

  const initBody = {
    snippet: { title, description: desc, categoryId: '22' }, // People & Blogs
    status: { privacyStatus: privacy }
  };
  if (takenISO || hasLoc){
    initBody.recordingDetails = {};
    if (takenISO) initBody.recordingDetails.recordingDate = takenISO;
    if (hasLoc) initBody.recordingDetails.location = { latitude: lat, longitude: lng, altitude: 0 };
  }

  let uploadUrl = '';
  try{
    const initRes = await fetch('https://www.googleapis.com/upload/youtube/v3/videos?uploadType=resumable&part=snippet,status,recordingDetails', {
      method:'POST',
      headers:{
        Authorization: 'Bearer '+accessToken,
        'Content-Type': 'application/json; charset=UTF-8',
        'X-Upload-Content-Length': f.size,
        'X-Upload-Content-Type': f.type || 'video/*'
      },
      body: JSON.stringify(initBody)
    });
    if (!initRes.ok) throw new Error('åˆå§‹åŒ–å¤±æ•—ï¼š'+ await initRes.text());
    uploadUrl = initRes.headers.get('Location');
    if (!uploadUrl) throw new Error('æœªå–å¾—çºŒå‚³ URL');
  }catch(e){
    result.innerHTML = `<div class="warn">âŒ åˆå§‹åŒ–å¤±æ•—ï¼š${escapeHtml(String(e))}</div>`;
    disableUI(false);
    return;
  }

  // 2) åˆ†æ®µä¸Šå‚³ + çºŒå‚³é‚è¼¯
  try{
    const videoId = await uploadResumable(file, uploadUrl);
    setProgress(98); setStatus('ä¸Šå‚³å®Œæˆï¼Œå›å¯« Google Sheetâ€¦');

    if (writeSheetEl.checked){
      await writeToGAS({
        upload_time: new Date().toISOString(),
        taken_time: takenISO || '',
        title, desc,
        lat: hasLoc ? lat : '',
        lng: hasLoc ? lng : '',
        category,
        video_id: videoId
      });
    }

    setProgress(100);
    result.innerHTML = `<div class="ok">âœ… ä¸Šå‚³å®Œæˆï¼š<a target="_blank" href="https://youtu.be/${videoId}">https://youtu.be/${videoId}</a></div>`;
    setStatus('å®Œæˆ');
    clearForm(); // â† æˆåŠŸå¾Œæ¸…ç©ºæ¬„ä½
  }catch(e){
    result.innerHTML = `<div class="warn">âŒ ç™¼ç”ŸéŒ¯èª¤ï¼š${escapeHtml(String(e))}</div>`;
    setStatus('å¤±æ•—');
  }finally{
    disableUI(false);
  }
}

/** å¯çºŒå‚³ä¸Šå‚³ï¼ˆåˆ†æ®µ PUTï¼›å¤±æ•—è‡ªå‹•æŸ¥è©¢å·²æ”¶ä½å…ƒçµ„å†çºŒï¼‰ */
async function uploadResumable(file, uploadUrl){
  let offset = 0;
  const total = file.size;

  // è‹¥è¦æ”¯æ´ã€Œæ–·ç·šå¾Œå†æŒ‰ä¸€æ¬¡ã€çš„çºŒå‚³ï¼šå…ˆå•ä¼ºæœå™¨å·²æ”¶å¤šå°‘
  offset = await queryUploadOffset(uploadUrl, total);

  while (offset < total) {
    await ensureAccessToken(); // é•·æ™‚é–“å¤§æª”ï¼Œé‚Šå‚³é‚Šç¢ºä¿ token

    const end = Math.min(offset + CHUNK_SIZE, total) - 1;
    const chunk = file.slice(offset, end + 1);

    const { status, range, responseText } = await putChunk(uploadUrl, chunk, offset, end, total, file.type || 'application/octet-stream');

    if (status === 308) {
      // ä¼ºæœå™¨å›ã€ŒResume Incompleteã€
      const last = parseRange(range);
      offset = (last != null) ? last + 1 : (end + 1);
      setProgress(Math.floor(offset / total * 100));
      setStatus(`çºŒå‚³ä¸­â€¦ ${Math.floor(offset/1024/1024)} / ${Math.floor(total/1024/1024)} MB`);
    } else if (status === 200 || status === 201) {
      // æœ€å¾Œä¸€å¡Šå®Œæˆï¼›å–å¾— videoId
      const json = safeJson(responseText);
      const videoId = json?.id;
      if (!videoId) throw new Error('ä¸Šå‚³å®Œæˆä½†æœªå–å¾— videoIdï¼š' + responseText.slice(0,200));
      return videoId;
    } else {
      // éé æœŸï¼›è©¢å•ä¼ºæœç«¯å·²æ”¶å¤šå°‘å¾Œå†çºŒ
      const serverOffset = await queryUploadOffset(uploadUrl, total);
      if (serverOffset > offset) {
        offset = serverOffset;
        setProgress(Math.floor(offset / total * 100));
      } else {
        throw new Error('ä¸Šå‚³å¤±æ•—ï¼ˆHTTP ' + status + 'ï¼‰ï¼š' + responseText.slice(0,200));
      }
    }
  }
  throw new Error('æ„å¤–çµæŸï¼šoffset==total ä½†æ²’æ”¶åˆ°å®Œæˆå›æ‡‰');
}

/** PUT ä¸€å€‹å€å¡Šï¼ˆä½¿ç”¨ XHR ä»¥å–å¾—æ›´å¹³æ»‘çš„ upload é€²åº¦ï¼‰ */
function putChunk(uploadUrl, chunk, start, end, total, contentType){
  return new Promise((resolve) => {
    const xhr = new XMLHttpRequest();
    xhr.open('PUT', uploadUrl, true);
    xhr.setRequestHeader('Content-Type', contentType);
    xhr.setRequestHeader('Content-Range', `bytes ${start}-${end}/${total}`);

    // æ¯å¡Šå…§éƒ¨ä¹Ÿæ›´æ–°é€²åº¦ï¼ˆæ›´å¹³æ»‘ï¼‰
    xhr.upload.onprogress = (e) => {
      if (e.lengthComputable) {
        const chunkProg = e.loaded / e.total;
        const absolute = ((start + (end-start+1)*chunkProg) / total) * 100;
        setProgress(Math.floor(absolute));
        setStatus(`ä¸Šå‚³ä¸­â€¦ ${Math.floor((start + (end-start+1)*chunkProg)/1024/1024)} / ${Math.floor(total/1024/1024)} MB`);
      }
    };

    xhr.onreadystatechange = () => {
      if (xhr.readyState === 4) {
        resolve({
          status: xhr.status,
          range: xhr.getResponseHeader('Range'), // e.g., "bytes=0-8388607"
          responseText: xhr.responseText || ''
        });
      }
    };
    xhr.send(chunk);
  });
}

/** è©¢å•ä¼ºæœå™¨ç›®å‰å·²ç¶“æ”¶åˆ°å“ªè£¡ï¼ˆContent-Range: bytes */totalï¼‰ */
function queryUploadOffset(uploadUrl, total){
  return new Promise((resolve) => {
    const xhr = new XMLHttpRequest();
    xhr.open('PUT', uploadUrl, true);
    xhr.setRequestHeader('Content-Range', `bytes */${total}`);
    xhr.onreadystatechange = () => {
      if (xhr.readyState === 4) {
        // æœŸå¾… 308ï¼Œä¸¦åœ¨ Range header å‘Šè¨´æˆ‘å€‘æœ€å¾Œä¸€å€‹ä½å…ƒçµ„
        if (xhr.status === 308) {
          const range = xhr.getResponseHeader('Range'); // "bytes=0-xxxx"
          const last = parseRange(range);
          resolve((last != null) ? last + 1 : 0);
        } else if (xhr.status === 200 || xhr.status === 201) {
          // è¡¨ç¤ºä¹‹å‰å…¶å¯¦å°±å·²ç¶“å®Œæˆï¼Ÿ
          const id = safeJson(xhr.responseText)?.id;
          if (id) { resolve(total); }
          else { resolve(0); }
        } else {
          resolve(0); // ç„¡æ³•åˆ¤æ–·å°±å¾ 0 é–‹å§‹
        }
      }
    };
    xhr.send(null);
  });
}

function parseRange(rangeHeader){
  if (!rangeHeader) return null;
  const m = rangeHeader.match(/bytes=(\d+)-(\d+)/);
  return m ? Number(m[2]) : null;
}

/** å¯«å› GASï¼ˆç”¨ text/plain é¿å…é æª¢ï¼‰ */
async function writeToGAS(payload){
  const res = await fetch(GAS_WEB_APP_URL, {
    method:'POST',
    headers:{ 'Content-Type':'text/plain;charset=utf-8' },
    body: JSON.stringify(payload)
  });
  const text = await res.text();
  let j; try { j = JSON.parse(text); } catch {
    throw new Error('GAS å›å‚³é JSONï¼š\n' + text.slice(0,300));
  }
  if (!res.ok || !j.ok) throw new Error(j.error || `HTTP ${res.status} ${res.statusText}`);
  return j;
}

/** å½±ç‰‡ä¸­ç¹¼è³‡æ–™è§£æï¼ˆåŒå‰ï¼‰ */
async function extractVideoMeta(file){
  const headSize = Math.min(file.size, 8*1024*1024);
  const headBuf  = await file.slice(0, headSize).arrayBuffer();
  let text = safeDecode(headBuf);
  let loc = findISO6709(text), cdate = findCreationDate(text);
  if ((!loc || !cdate) && headSize < file.size){
    const fullBuf = await file.arrayBuffer();
    text = safeDecode(fullBuf);
    if (!loc)   loc   = findISO6709(text);
    if (!cdate) cdate = findCreationDate(text);
  }
  if (!loc)   loc   = findAfterKey(text, 'com.apple.quicktime.location.ISO6709');
  if (!cdate) cdate = findAfterKey(text, 'com.apple.quicktime.creationdate') || findAfterKey(text, 'Â©day');
  return {
    creation: normalizeDateTime(cdate) || null,
    location: loc ? iso6709ToLatLng(loc) : null
  };
}

function findISO6709(s){ const re=/[+-]\d{1,2}\.\d{3,}[+-]\d{1,3}\.\d{3,}(?:[+-]\d{1,3}\.\d+)?\/?/; const m=s.match(re); return m?m[0]:null; }
function findAfterKey(s,key){ const i=s.indexOf(key); if(i===-1) return null; const t=s.slice(i+key.length,i+key.length+200);
  const tm=t.match(/\d{4}-\d{2}-\d{2}[ T]\d{2}:\d{2}:\d{2}(?:\.\d+)?Z?/); if(tm) return tm[0];
  const lm=t.match(/[+-]\d{1,2}\.\d{3,}[+-]\d{1,3}\.\d{3,}(?:[+-]\d{1,3}\.\d+)?\/?/); if(lm) return lm[0];
  const pr=t.match(/[\x20-\x7E]{6,}/); return pr?pr[0].trim():null; }
function findCreationDate(s){ let m=s.match(/\d{4}-\d{2}-\d{2}[ T]\d{2}:\d{2}:\d{2}(?:\.\d+)?Z?/); if(m) return m[0]; m=s.match(/\d{4}:\d{2}:\d{2}\s\d{2}:\d{2}:\d{2}/); return m?m[0]:null; }
function iso6709ToLatLng(str){ const re=/^([+-]\d{1,2}\.\d+)([+-]\d{1,3}\.\d+)([+-]\d{1,3}\.\d+)?\/?$/; const m=str.match(re); if(!m) return null;
  return {lat:parseFloat(m[1]), lng:parseFloat(m[2]), alt:m[3]?parseFloat(m[3]):null}; }
function normalizeDateTime(s){ if(!s) return null;
  if(/^\d{4}-\d{2}-\d{2}[ T]\d{2}:\d{2}:\d{2}/.test(s)){ const t=s.replace(' ','T'); try{ return new Date(t).toISOString(); }catch{} }
  if(/^\d{4}:\d{2}:\d{2}\s\d{2}:\d{2}:\d{2}$/.test(s)){ const t=s.replace(/^(\d{4}):(\d{2}):(\d{2})\s/,'$1-$2-$3T')+'Z'; try{ return new Date(t).toISOString(); }catch{} }
  return s;
}
function safeDecode(buf){ try{ return new TextDecoder('utf-8',{fatal:false}).decode(buf);}catch{ let s=''; const c=1<<20; for(let i=0;i<buf.byteLength;i+=c){ const v=new DataView(buf,i,Math.min(c,buf.byteLength-i)); const a=new Uint8Array(v.buffer,v.byteOffset,v.byteLength); s+=new TextDecoder('utf-8',{fatal:false}).decode(a);} return s; } }
function toLocalDatetimeInputValue(d){ const pad=n=>String(n).padStart(2,'0'); const y=d.getFullYear(), m=pad(d.getMonth()+1), da=pad(d.getDate()), h=pad(d.getHours()), mi=pad(d.getMinutes()); return `${y}-${m}-${da}T${h}:${mi}`; }
function safeJson(t){ try{ return JSON.parse(t);}catch{ return {}; } }
function escapeHtml(s){ return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#39;'); }

function setStatus(msg){ statusEl.textContent = msg; }
function setProgress(p){ bar.style.width = Math.max(0, Math.min(100, p)) + '%'; }
function disableUI(dis){
  [btnAuth, fileInput, btnUseParsed, btnGeo, btnUpload, titleEl, descEl, catEl, privacyEl, takenEl, latEl, lngEl, writeSheetEl]
    .forEach(elm => elm.disabled = !!dis);
}

/** æˆåŠŸå¾Œæ¸…ç©ºæ¬„ä½ï¼ˆå¯«å› Sheet è‹¥å¤±æ•—å‰‡ä¸æ¸…ç©ºï¼‰ */
function clearForm(){
  fileInput.value = '';
  titleEl.value = '';
  descEl.value = '';
  catEl.value = '';
  privacyEl.value = 'unlisted';
  takenEl.value = '';
  latEl.value = '';
  lngEl.value = '';
  geoInfo.textContent = '';
  parseBox.textContent = 'å°šæœªè§£æã€‚';
  setProgress(0);
}
</script>
</body>
</html>
