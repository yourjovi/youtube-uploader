<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ffmpeg.wasm å€’æ”¾æ¸¬è©¦</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto; margin:16px;}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .log{white-space:pre-wrap; background:#0b1020; color:#e6f0ff; padding:10px; border-radius:8px; min-height:100px}
    video{max-width:100%; background:#000; border-radius:8px}
    .btn{padding:10px 14px; border-radius:10px; border:1px solid #e5e7eb; cursor:pointer}
    .btn.primary{background:#2563eb; color:#fff; border-color:#2563eb}
    .muted{color:#6b7280}
  </style>

  <!-- â‘  ffmpegï¼ˆUMDï¼Œå…¨åŸŸè®Šæ•¸ FFmpegï¼‰ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ffmpeg/0.12.15/umd/ffmpeg.min.js"
          crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body>
  <h1>ğŸï¸ ffmpeg.wasm å€’æ”¾æ¸¬è©¦</h1>
  <div class="row">
    <input id="file" type="file" accept="video/mp4,video/webm,video/quicktime"/>
    <button id="btn" class="btn primary" disabled>é–‹å§‹è½‰æˆå€’æ”¾</button>
    <span id="hint" class="muted">é¸ 10ï½20 ç§’çš„å°æª”å…ˆæ¸¬è©¦</span>
  </div>

  <h3 style="margin-top:18px">è½‰æª”çµæœ</h3>
  <video id="out" controls></video>
  <div style="margin-top:8px"><a id="dl" download="reversed.mp4" class="btn">ä¸‹è¼‰ reversed.mp4</a></div>

  <h3 style="margin-top:18px">é™¤éŒ¯è¨Šæ¯</h3>
  <div id="log" class="log"></div>

<script>
const logBox = document.getElementById('log');
const outEl  = document.getElementById('out');
const dlEl   = document.getElementById('dl');
const btn    = document.getElementById('btn');
const fileEl = document.getElementById('file');

// â‘¡ æŒ‡å®š core æª”ï¼ˆå¿…è¦ï¼‰
const CORE_URL = 'https://cdn.jsdelivr.net/npm/@ffmpeg/core@0.12.10/dist/umd/ffmpeg-core.js'; // å–®åŸ·è¡Œç·’æ ¸å¿ƒ
// ç‰ˆæœ¬/è·¯å¾‘åƒè€ƒï¼š@ffmpeg/ffmpeg 0.12.15 çš„ UMD åœ¨ dist/umd/ï¼ˆcdnjs å·²æ”¶éŒ„ï¼‰ï¼›@ffmpeg/core 0.12.10 çš„ UMD è·¯å¾‘å¦‚ä¸Šã€‚ :contentReference[oaicite:2]{index=2}

let ffmpeg;

function log(...args){
  console.log(...args);
  logBox.textContent += args.map(a => typeof a === 'string' ? a : JSON.stringify(a)).join(' ') + '\n';
}

async function ensureFFmpeg(){
  if (ffmpeg) return;
  if (!window.FFmpeg) throw new Error('FFmpeg UMD æ²’æœ‰è¼‰åˆ°ï¼ˆæª¢æŸ¥ cdnjs é€£ç·š/è·¯å¾‘ï¼‰');
  const { createFFmpeg, fetchFile } = window.FFmpeg;
  if (!createFFmpeg) throw new Error('createFFmpeg ä¸å­˜åœ¨ï¼šUMD ç‰ˆæœ¬ä¸ç¬¦æˆ–è¼‰å…¥å¤±æ•—');

  ffmpeg = createFFmpeg({
    log: true,
    corePath: CORE_URL
  });
  ffmpeg.setLogger(({ type, message }) => {
    if (type === 'fferr' || type === 'ffout') log(message);
  });

  log('ğŸ”Œ è¼‰å…¥ ffmpeg coreâ€¦', CORE_URL);
  await ffmpeg.load();   // æœƒå»æŠ“ ffmpeg-core.js / .wasm
  log('âœ… ffmpeg æ ¸å¿ƒè¼‰å…¥å®Œæˆ');
}

fileEl.addEventListener('change', () => {
  btn.disabled = !fileEl.files?.[0];
});

btn.addEventListener('click', async () => {
  const f = fileEl.files?.[0];
  if (!f) return alert('è«‹å…ˆé¸å½±ç‰‡');
  btn.disabled = true; log('ğŸ“¦ æº–å‚™è½‰æª”ï¼š', f.name, Math.round(f.size/1024/1024)+'MB');

  try{
    await ensureFFmpeg();

    const { fetchFile } = FFmpeg;
    const inputName  = 'in.' + (f.name.split('.').pop() || 'mp4').toLowerCase();
    const outputName = 'out.mp4';

    // å¯«å…¥è™›æ“¬æª”æ¡ˆç³»çµ±
    ffmpeg.FS('writeFile', inputName, await fetchFile(f));
    log('ğŸ“ å¯«å…¥è™›æ“¬æª”æ¡ˆï¼š', inputName);

    // â‘¢ å½±ç‰‡å€’æ”¾ï¼šå½±åƒ + è²éŸ³
    //    æ³¨æ„ï¼šreverse/areverse éœ€è¦æŠŠæ•´æ®µè¼‰å…¥è¨˜æ†¶é«”ï¼Œè«‹å…ˆç”¨çŸ­ç‰‡æ¸¬ã€‚
    log('ğŸ› ï¸ åŸ·è¡Œ ffmpegâ€¦');
    await ffmpeg.run(
      '-i', inputName,
      '-vf', 'reverse',
      '-af', 'areverse',
      '-movflags', 'faststart',
      outputName
    );

    log('âœ… å®Œæˆï¼Œè®€å‡ºçµæœâ€¦');
    const data = ffmpeg.FS('readFile', outputName);
    const blob = new Blob([data.buffer], { type: 'video/mp4' });
    const url  = URL.createObjectURL(blob);

    outEl.src = url; outEl.load(); outEl.play().catch(()=>{});
    dlEl.href = url;
    log('ğŸ‰ è½‰æª”æˆåŠŸï¼Œå¤§å°ï¼š' + (Math.round(blob.size/1024/1024)) + 'MB');
  }catch(err){
    console.error(err);
    log('âŒ è½‰æª”å¤±æ•—ï¼š' + (err?.message || err));
    alert('è½‰æª”å¤±æ•—ï¼š' + (err?.message || err));
  }finally{
    btn.disabled = false;
  }
});
</script>
</body>
</html>
