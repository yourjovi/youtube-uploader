<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ffmpeg.wasm å€’æ”¾æ¸¬è©¦ï¼ˆESM/UMD + æœ¬åœ°å‚™æ´ï¼‰</title>
<style>
  body{font-family:system-ui,-apple-system,"Segoe UI",Roboto; margin:16px;}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  video{max-width:100%;background:#000;border-radius:8px}
  #log{white-space:pre-wrap;background:#0b1020;color:#cfe1ff;padding:12px;border-radius:8px;
       font-family:ui-monospace,Consolas,monospace;font-size:12px;line-height:1.6;max-height:40vh;overflow:auto}
  .hint{color:#555;margin:6px 0 12px}
  .btn{padding:10px 14px;border-radius:999px;border:1px solid #e5e7eb;background:#fff;cursor:pointer}
  .btn.primary{background:#2563eb;color:#fff;border-color:#2563eb}
</style>
</head>
<body>
  <h1>ğŸ¬ ffmpeg.wasm å€’æ”¾æ¸¬è©¦</h1>
  <div class="hint">
    å»ºè­°å…ˆç”¨ <b>3â€“10 ç§’</b>çš„å°ç‰‡æ®µæ¸¬è©¦ã€‚è‹¥ CDN è¢«æ“‹ï¼Œå¯æŠŠ core æª”æ”¾åˆ° <code>./vendor/core/</code>ï¼ˆæ­¤é å·²æ”¯æ´ï¼‰ã€‚
  </div>

  <div class="row">
    <input id="file" type="file" accept="video/*">
    <button id="btnRun" class="btn primary">é–‹å§‹å€’æ”¾</button>
    <a id="dl" class="btn" download="reversed.mp4" style="display:none">ä¸‹è¼‰çµæœ</a>
  </div>

  <h3>åŸå§‹å½±ç‰‡</h3>
  <video id="vIn" controls></video>

  <h3>å€’æ”¾çµæœ</h3>
  <video id="vOut" controls></video>

  <h3>è¨˜éŒ„</h3>
  <div id="log"></div>

<script type="module">
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€ ç‰ˆæœ¬èˆ‡ä¾†æº â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const VERS = { ffmpeg: '0.12.10', core: '0.12.10', util: '0.12.1' };
const CDN = {
  ESM_FFMPEG: `https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@${VERS.ffmpeg}/dist/esm/index.js`,
  UMD_FFMPEG: `https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@${VERS.ffmpeg}/dist/umd/ffmpeg.js`,
  ESM_UTIL  : `https://cdn.jsdelivr.net/npm/@ffmpeg/util@${VERS.util}/dist/esm/index.js`,
  CORE_ESM  : `https://cdn.jsdelivr.net/npm/@ffmpeg/core@${VERS.core}/dist/esm`,
  CORE_UMD  : `https://cdn.jsdelivr.net/npm/@ffmpeg/core@${VERS.core}/dist/umd`
};

// è‹¥ CDN è¢«æ“‹ï¼ŒæŠŠ @ffmpeg/core çš„ä¸‰å€‹æª”æ¡ˆæ”¾åˆ° repoï¼š./vendor/core/ffmpeg-core.{js,wasm,worker.js}
const USE_LOCAL_CORE = false;                 // â† è‹¥æ”¹ true å°±ç”¨æœ¬åœ° core
const LOCAL_CORE_BASE = './vendor/core';

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€ å°å·¥å…· â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const logEl = document.getElementById('log');
const log = (...a) => { console.log(...a); logEl.textContent += a.join(' ') + '\n'; };

async function toBlobURL(url, mime){
  const r = await fetch(url, { cache: 'force-cache' });
  if (!r.ok) throw new Error(`fetch ${url} ${r.status}`);
  const b = await r.blob();
  return URL.createObjectURL(new Blob([b], { type: mime }));
}
async function fetchFileAny(input){
  if (input instanceof File || input instanceof Blob) {
    return new Uint8Array(await input.arrayBuffer());
  }
  const r = await fetch(input); return new Uint8Array(await r.arrayBuffer());
}
function loadScript(src){
  return new Promise((res, rej) => {
    const s = document.createElement('script');
    s.src = src; s.onload = () => res(); s.onerror = () => rej(new Error('script load fail: '+src));
    document.head.appendChild(s);
  });
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€ è¼‰å…¥ FFmpegï¼šå„ªå…ˆ ESM â†’ é€€ UMD â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let FFmpegClass, fetchFile, utilToBlobURL;

let coreBaseESM = USE_LOCAL_CORE ? LOCAL_CORE_BASE : CDN.CORE_ESM;
let coreBaseUMD = USE_LOCAL_CORE ? LOCAL_CORE_BASE : CDN.CORE_UMD;

async function loadFFmpeg(){
  // 1) ESM
  try{
    const m = await import(CDN.ESM_FFMPEG);
    const u = await import(CDN.ESM_UTIL);
    FFmpegClass = m.FFmpeg;
    fetchFile = u.fetchFile;       // å®˜æ–¹ util
    utilToBlobURL = u.toBlobURL;   // å®˜æ–¹ utilï¼ˆæœƒè‡ªå‹•è¨­æ­£ç¢º MIMEï¼‰
    log('âœ” è¼‰å…¥ ESM æˆåŠŸï¼š', CDN.ESM_FFMPEG);
    return 'esm';
  }catch(e){
    log('âš  ESM å¤±æ•—ï¼Œæ”¹ç”¨ UMDï¼š', e.message || e);
  }
  // 2) UMD å‚™æ´
  await loadScript(CDN.UMD_FFMPEG);
  if (!window.FFmpeg) throw new Error('FFmpeg UMD æ²’æœ‰è¼‰åˆ°ï¼ˆæª¢æŸ¥ CDN é€£ç·š/è·¯å¾‘ï¼‰');
  FFmpegClass = window.FFmpeg;
  fetchFile = fetchFileAny;        // è‡ªå‚™ util
  utilToBlobURL = toBlobURL;       // è‡ªå‚™ util
  log('âœ” è¼‰å…¥ UMD æˆåŠŸï¼š', CDN.UMD_FFMPEG);
  return 'umd';
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€ ä¸»æµç¨‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const fileEl = document.getElementById('file');
const vIn  = document.getElementById('vIn');
const vOut = document.getElementById('vOut');
const btn  = document.getElementById('btnRun');
const dl   = document.getElementById('dl');

fileEl.addEventListener('change', () => {
  const f = fileEl.files?.[0];
  if (!f) return;
  vIn.src = URL.createObjectURL(f);
  vOut.removeAttribute('src'); vOut.load();
  dl.style.display = 'none';
  log('é¸åˆ°æª”æ¡ˆï¼š', f.name, Math.round(f.size/1024/1024)+'MB');
});

btn.addEventListener('click', async () => {
  const f = fileEl.files?.[0];
  if (!f) { alert('è«‹å…ˆé¸æ“‡å½±ç‰‡'); return; }

  try{
    btn.disabled = true; logEl.textContent = '';
    const mode = await loadFFmpeg();

    const ffmpeg = new FFmpegClass();
    ffmpeg.on('log', e => log('[ffmpeg]', e.message));

    // â€”â€” æŒ‡å®š core èˆ‡ workerï¼ˆå…¨éƒ¨è½‰ Blob URLï¼Œé¿å… CORS/åŒæºé™åˆ¶ï¼‰
    const base = (mode === 'esm') ? coreBaseESM : coreBaseUMD;
    log('æ ¸å¿ƒä¾†æºï¼š', base);
    await ffmpeg.load({
      coreURL:   await utilToBlobURL(`${base}/ffmpeg-core.js`,         'text/javascript'),
      wasmURL:   await utilToBlobURL(`${base}/ffmpeg-core.wasm`,       'application/wasm'),
      workerURL: await utilToBlobURL(`${base}/ffmpeg-core.worker.js`,  'text/javascript')
    });

    // å¯«å…¥æª”æ¡ˆ â†’ åŸ·è¡Œå€’æ”¾ â†’ è®€å‡º
    await ffmpeg.writeFile('in.mp4', await fetchFile(f));
    log('é–‹å§‹å€’æ”¾â€¦ï¼ˆæ™‚é–“è¦–æª”æ¡ˆå¤§å°è€Œå®šï¼‰');
    await ffmpeg.exec([
      '-i','in.mp4',
      '-vf','reverse',
      '-af','areverse',
      '-movflags','faststart',
      'out.mp4'
    ]);

    const data = await ffmpeg.readFile('out.mp4');
    const blob = new Blob([data], { type:'video/mp4' });
    const url = URL.createObjectURL(blob);

    vOut.src = url; vOut.play().catch(()=>{});
    dl.href = url; dl.style.display = 'inline-block';
    log('âœ… è½‰æª”æˆåŠŸï¼Œå¯æ’­æ”¾æˆ–ä¸‹è¼‰ã€‚');
  }catch(err){
    console.error(err);
    log('âŒ è½‰æª”å¤±æ•—ï¼š', String(err?.message || err));
    alert('è½‰æª”å¤±æ•—ï¼š' + (err?.message || err));
  }finally{
    btn.disabled = false;
  }
});
</script>
</body>
  2
</html>
